<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Practical R for Epidemiologists</title>
  <meta name="description" content="This guide is intended as a practical introduction to using the R environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending R using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g. calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications. If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider purchasing this book.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Practical R for Epidemiologists" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://guevarra.io/prfe/" />
  <meta property="og:image" content="http://guevarra.io/prfe/images/bookcover.jpg" />
  <meta property="og:description" content="This guide is intended as a practical introduction to using the R environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending R using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g. calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications. If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider purchasing this book." />
  <meta name="github-repo" content="ernestguevarra/practical-r-for-epidemiologists" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Practical R for Epidemiologists" />
  
  <meta name="twitter:description" content="This guide is intended as a practical introduction to using the R environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending R using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g. calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications. If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider purchasing this book." />
  <meta name="twitter:image" content="http://guevarra.io/prfe/images/bookcover.jpg" />

<meta name="author" content="Mark Myatt and Ernest Guevarra">


<meta name="date" content="2018-05-08">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="exercise6.html">
<link rel="next" href="exercise8.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118912078-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118912078-1');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; min-height: 1.25em; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; }
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
pre, code { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; color: initial; }
}
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.bn { color: #0000cf; } /* BaseN */
code span.fl { color: #0000cf; } /* Float */
code span.ch { color: #4e9a06; } /* Char */
code span.st { color: #4e9a06; } /* String */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.ot { color: #8f5902; } /* Other */
code span.al { color: #ef2929; } /* Alert */
code span.fu { color: #000000; } /* Function */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code span.cn { color: #000000; } /* Constant */
code span.sc { color: #000000; } /* SpecialChar */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.im { } /* Import */
code span.va { color: #000000; } /* Variable */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.ex { } /* Extension */
code span.at { color: #c4a000; } /* Attribute */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Practical R for Epidemiologists</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="introducing-r.html"><a href="introducing-r.html"><i class="fa fa-check"></i>Introducing R</a><ul>
<li class="chapter" data-level="0.1" data-path="introducing-r.html"><a href="introducing-r.html#retrieving-data"><i class="fa fa-check"></i><b>0.1</b> Retrieving data</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="exercise1.html"><a href="exercise1.html"><i class="fa fa-check"></i><b>1</b> Getting acquainted with R</a><ul>
<li class="chapter" data-level="1.1" data-path="exercise1.html"><a href="exercise1.html#summary"><i class="fa fa-check"></i><b>1.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="exercise2.html"><a href="exercise2.html"><i class="fa fa-check"></i><b>2</b> Manipulating objects and creating new functions</a><ul>
<li class="chapter" data-level="2.1" data-path="exercise2.html"><a href="exercise2.html#summary-1"><i class="fa fa-check"></i><b>2.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="exercise3.html"><a href="exercise3.html"><i class="fa fa-check"></i><b>3</b> Logistic regression and stratified analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="exercise3.html"><a href="exercise3.html#matched-data"><i class="fa fa-check"></i><b>3.1</b> Matched data</a></li>
<li class="chapter" data-level="3.2" data-path="exercise3.html"><a href="exercise3.html#summary-2"><i class="fa fa-check"></i><b>3.2</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="exercise4.html"><a href="exercise4.html"><i class="fa fa-check"></i><b>4</b> Analysing some data with R</a><ul>
<li class="chapter" data-level="4.1" data-path="exercise4.html"><a href="exercise4.html#summary-3"><i class="fa fa-check"></i><b>4.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="exercise5.html"><a href="exercise5.html"><i class="fa fa-check"></i><b>5</b> Extending R with packages</a><ul>
<li class="chapter" data-level="5.1" data-path="exercise5.html"><a href="exercise5.html#summary-4"><i class="fa fa-check"></i><b>5.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exercise6.html"><a href="exercise6.html"><i class="fa fa-check"></i><b>6</b> Making your own objects behave like R objects</a><ul>
<li class="chapter" data-level="6.1" data-path="exercise6.html"><a href="exercise6.html#summary-5"><i class="fa fa-check"></i><b>6.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="exercise7.html"><a href="exercise7.html"><i class="fa fa-check"></i><b>7</b> Writing your own graphical functions</a><ul>
<li class="chapter" data-level="7.1" data-path="exercise7.html"><a href="exercise7.html#summary-6"><i class="fa fa-check"></i><b>7.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exercise8.html"><a href="exercise8.html"><i class="fa fa-check"></i><b>8</b> More graphical functions</a><ul>
<li class="chapter" data-level="8.1" data-path="exercise8.html"><a href="exercise8.html#population-pyramid"><i class="fa fa-check"></i><b>8.1</b> Population pyramid</a></li>
<li class="chapter" data-level="8.2" data-path="exercise8.html"><a href="exercise8.html#pareto-chart"><i class="fa fa-check"></i><b>8.2</b> Pareto chart</a></li>
<li class="chapter" data-level="8.3" data-path="exercise8.html"><a href="exercise8.html#adding-confidence-intervals-or-error-bars-on-plots"><i class="fa fa-check"></i><b>8.3</b> Adding confidence intervals or error bars on plots</a></li>
<li class="chapter" data-level="8.4" data-path="exercise8.html"><a href="exercise8.html#mesh-map"><i class="fa fa-check"></i><b>8.4</b> Mesh map</a></li>
<li class="chapter" data-level="8.5" data-path="exercise8.html"><a href="exercise8.html#combining-plots"><i class="fa fa-check"></i><b>8.5</b> Combining plots</a></li>
<li class="chapter" data-level="8.6" data-path="exercise8.html"><a href="exercise8.html#summary-7"><i class="fa fa-check"></i><b>8.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="exercise9.html"><a href="exercise9.html"><i class="fa fa-check"></i><b>9</b> Computer intensive methods</a><ul>
<li class="chapter" data-level="9.1" data-path="exercise9.html"><a href="exercise9.html#estimation"><i class="fa fa-check"></i><b>9.1</b> Estimation</a></li>
<li class="chapter" data-level="9.2" data-path="exercise9.html"><a href="exercise9.html#hypothesis-testing"><i class="fa fa-check"></i><b>9.2</b> Hypothesis testing</a></li>
<li class="chapter" data-level="9.3" data-path="exercise9.html"><a href="exercise9.html#simulating-processes"><i class="fa fa-check"></i><b>9.3</b> Simulating processes</a></li>
<li class="chapter" data-level="9.4" data-path="exercise9.html"><a href="exercise9.html#cellular-automata-machines"><i class="fa fa-check"></i><b>9.4</b> Cellular automata machines</a></li>
<li class="chapter" data-level="9.5" data-path="exercise9.html"><a href="exercise9.html#summary-8"><i class="fa fa-check"></i><b>9.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="what-now.html"><a href="what-now.html"><i class="fa fa-check"></i>What now?</a></li>
<li class="divider"></li>
<li>&nbsp; &nbsp; @ Mark Myatt and Ernest Guevarra 2018</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Practical R for Epidemiologists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="exercise7" class="section level1">
<h1><span class="header-section-number">Exercise 7</span> Writing your own graphical functions</h1>
<p><code>R</code> provides a pretty full set of graphical functions for plotting data as well as <code>plot()</code> methods for a wide variety of statistical functions. There will be times, however, when you will need to write you own graphical functions to present and analyse data in a specific way. In this exercise we will create a function that produces a plot that may be used for assessing agreement between two methods of clinical measurement as described in:</p>
<pre><code>Bland JM, Altman DG. Statistical Methods for Assessing Agreement Between Two Methods of Clinical Measurement. Lancet. 1986;1: 307–310. </code></pre>
<p>Which involves plotting the difference of two measurements against the mean of the two measurements and calculating and displaying limits of agreement.</p>
<p>Start <code>R</code> and retrieve and attach the sample dataset:</p>
<pre class="sourceCode r" id="cb520"><code class="sourceCode r"><a class="sourceLine" id="cb520-1" data-line-number="1">ba &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;ba.dat&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb520-2" data-line-number="2"><span class="kw">attach</span>(ba)</a></code></pre>
<p>The <code>ba</code> data.frame contains measurements (in litres per minute) taken with a <em>Wright peak flow meter</em> and a <em>Mini-Wright peak flow meter</em>. This is the same data that is presented in the referenced Lancet article:</p>
<pre><code>##    Wright Mini
## 1     494  512
## 2     395  430
## 3     516  520
## 4     434  428
## 5     476  500
## 6     557  600
## 7     413  364
## 8     442  380
## 9     650  658
## 10    433  445
## 11    417  432
## 12    656  626
## 13    267  260
## 14    478  477
## 15    178  259
## 16    423  350
## 17    427  451</code></pre>
<p>You can examine the <code>ba</code> data.frame using the <code>print()</code> and <code>summary()</code> functions:</p>
<pre class="sourceCode r" id="cb522"><code class="sourceCode r"><a class="sourceLine" id="cb522-1" data-line-number="1"><span class="kw">print</span>(ba)</a>
<a class="sourceLine" id="cb522-2" data-line-number="2">ba</a>
<a class="sourceLine" id="cb522-3" data-line-number="3"><span class="kw">summary</span>(ba)</a></code></pre>
<pre><code>##    Wright Mini
## 1     494  512
## 2     395  430
## 3     516  520
## 4     434  428
## 5     476  500
## 6     557  600
## 7     413  364
## 8     442  380
## 9     650  658
## 10    433  445
## 11    417  432
## 12    656  626
## 13    267  260
## 14    478  477
## 15    178  259
## 16    423  350
## 17    427  451</code></pre>
<pre><code>##    Wright Mini
## 1     494  512
## 2     395  430
## 3     516  520
## 4     434  428
## 5     476  500
## 6     557  600
## 7     413  364
## 8     442  380
## 9     650  658
## 10    433  445
## 11    417  432
## 12    656  626
## 13    267  260
## 14    478  477
## 15    178  259
## 16    423  350
## 17    427  451</code></pre>
<pre><code>##      Wright           Mini      
##  Min.   :178.0   Min.   :259.0  
##  1st Qu.:417.0   1st Qu.:380.0  
##  Median :434.0   Median :445.0  
##  Mean   :450.4   Mean   :452.5  
##  3rd Qu.:494.0   3rd Qu.:512.0  
##  Max.   :656.0   Max.   :658.0</code></pre>
<p>The <code>function()</code> function allows us to create new functions in <code>R</code>:</p>
<pre class="sourceCode r" id="cb526"><code class="sourceCode r"><a class="sourceLine" id="cb526-1" data-line-number="1">ba.plot &lt;-<span class="st"> </span><span class="cf">function</span>(a, b) {}</a></code></pre>
<p>This creates an empty function called <code>ba.plot()</code> that expects two parameters called <code>a</code> and <code>b</code>. We could type the whole function in at the <code>R</code> command prompt but it is easier to use a text editor:</p>
<pre class="sourceCode r" id="cb527"><code class="sourceCode r"><a class="sourceLine" id="cb527-1" data-line-number="1"><span class="kw">fix</span>(ba.plot)</a></code></pre>
<p>We will start be writing a basic function which we will gradually improve throughout this exercise.</p>
<p>Edit the <code>ba.plot()</code> function to read:</p>
<pre class="sourceCode r" id="cb528"><code class="sourceCode r"><a class="sourceLine" id="cb528-1" data-line-number="1"><span class="cf">function</span>(a, b) {</a>
<a class="sourceLine" id="cb528-2" data-line-number="2">  mean.two &lt;-<span class="st"> </span>(a <span class="op">+</span><span class="st"> </span>b) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb528-3" data-line-number="3">  diff.two &lt;-<span class="st"> </span>a <span class="op">-</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb528-4" data-line-number="4">  <span class="kw">plot</span>(mean.two, diff.two)</a>
<a class="sourceLine" id="cb528-5" data-line-number="5">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>The function calculates the mean and the difference of the two measures and then plots the results. Lets try the
<code>ba.plot()</code> function with the test data:</p>
<pre class="sourceCode r" id="cb529"><code class="sourceCode r"><a class="sourceLine" id="cb529-1" data-line-number="1"><span class="kw">ba.plot</span>(Wright, Mini)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-286-1.png" width="672" /></p>
<p>The resulting plot is rather plain and lacks meaningful titles and axis labels. Use the <code>fix()</code> function to edit the <code>ba.plot()</code> function:</p>
<pre class="sourceCode r" id="cb530"><code class="sourceCode r"><a class="sourceLine" id="cb530-1" data-line-number="1"><span class="kw">fix</span>(ba.plot)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb531"><code class="sourceCode r"><a class="sourceLine" id="cb531-1" data-line-number="1"><span class="cf">function</span>(a, b, <span class="dt">title =</span> <span class="st">&quot;Bland and Altman Plot&quot;</span>) {</a>
<a class="sourceLine" id="cb531-2" data-line-number="2">  a.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(a))</a>
<a class="sourceLine" id="cb531-3" data-line-number="3">  b.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(b))</a>
<a class="sourceLine" id="cb531-4" data-line-number="4">  x.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Mean of&quot;</span>, a.txt, <span class="st">&quot;and&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb531-5" data-line-number="5">  y.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(a.txt, <span class="st">&quot;-&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb531-6" data-line-number="6">  mean.two &lt;-<span class="st"> </span>(a <span class="op">+</span><span class="st"> </span>b) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb531-7" data-line-number="7">  diff.two &lt;-<span class="st"> </span>a <span class="op">-</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb531-8" data-line-number="8">  <span class="kw">plot</span>(mean.two, diff.two, <span class="dt">xlab =</span> x.lab, <span class="dt">ylab =</span> y.lab, <span class="dt">main =</span> title)</a>
<a class="sourceLine" id="cb531-9" data-line-number="9">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We have added a new parameter (<code>title</code>) to the function and given this a default value of <code>Bland and Altman Plot</code>. Adding <code>title</code> as a parameter means that we will be able to specify a title for the plot when we call the function. We have also used the function combination <code>deparse(substitute())</code> to retrieve the names of the vectors passed to parameters <code>a</code> and <code>b</code>. The <code>paste()</code> function pastes pieces of text together. It is used here to create the text for the axis labels used with the <code>plot()</code> function.</p>
<p>Lets try the <code>ba.plot()</code> function with the test data:</p>
<pre class="sourceCode r" id="cb532"><code class="sourceCode r"><a class="sourceLine" id="cb532-1" data-line-number="1"><span class="kw">ba.plot</span>(Wright, Mini)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-290-1.png" width="672" /></p>
<p>We may also specify a title for the plot using the title parameter:</p>
<pre class="sourceCode r" id="cb533"><code class="sourceCode r"><a class="sourceLine" id="cb533-1" data-line-number="1"><span class="kw">ba.plot</span>(Wright, Mini, <span class="dt">title =</span> <span class="st">&quot;PEFR data&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-291-1.png" width="672" /></p>
<p>We can now edit the function to calculate and plot mean, difference, and the limits of agreement. Use the <code>fix()</code> function to edit the <code>ba.plot()</code> function:</p>
<pre class="sourceCode r" id="cb534"><code class="sourceCode r"><a class="sourceLine" id="cb534-1" data-line-number="1"><span class="kw">fix</span>(ba.plot)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb535"><code class="sourceCode r"><a class="sourceLine" id="cb535-1" data-line-number="1"><span class="cf">function</span>(a, b, <span class="dt">title =</span> <span class="st">&quot;Bland and Altman Plot&quot;</span>) {</a>
<a class="sourceLine" id="cb535-2" data-line-number="2">  a.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(a))</a>
<a class="sourceLine" id="cb535-3" data-line-number="3">  b.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(b))</a>
<a class="sourceLine" id="cb535-4" data-line-number="4">  x.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Mean of&quot;</span>, a.txt, <span class="st">&quot;and&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb535-5" data-line-number="5">  y.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(a.txt, <span class="st">&quot;-&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb535-6" data-line-number="6">  mean.two &lt;-<span class="st"> </span>(a <span class="op">+</span><span class="st"> </span>b) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb535-7" data-line-number="7">  diff.two &lt;-<span class="st"> </span>a <span class="op">-</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb535-8" data-line-number="8">  <span class="kw">plot</span>(mean.two, diff.two, <span class="dt">xlab =</span> x.lab, <span class="dt">ylab =</span> y.lab, <span class="dt">main =</span> title) </a>
<a class="sourceLine" id="cb535-9" data-line-number="9">  mean.diff &lt;-<span class="st"> </span><span class="kw">mean</span>(diff.two)</a>
<a class="sourceLine" id="cb535-10" data-line-number="10">  sd.diff &lt;-<span class="st"> </span><span class="kw">sd</span>(diff.two)</a>
<a class="sourceLine" id="cb535-11" data-line-number="11">  upper &lt;-<span class="st"> </span>mean.diff <span class="op">+</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>sd.diff</a>
<a class="sourceLine" id="cb535-12" data-line-number="12">  lower &lt;-<span class="st"> </span>mean.diff <span class="op">-</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>sd.diff</a>
<a class="sourceLine" id="cb535-13" data-line-number="13">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(mean.diff, mean.diff), <span class="dt">lty =</span> <span class="dv">3</span>) </a>
<a class="sourceLine" id="cb535-14" data-line-number="14">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(upper, upper), <span class="dt">lty =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb535-15" data-line-number="15">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(lower, lower), <span class="dt">lty =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb535-16" data-line-number="16">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file and quit the editor.</p>
<p>We have used the <code>mean()</code> and <code>sd()</code> functions to calculate the mean and standard deviation of the difference between the two measures and calculated the limits of agreement (<code>upper</code> and <code>lower</code>) assuming that the differences are <em>Normally</em> distributed.</p>
<p>The <code>lines()</code> function is then used to plot the mean and the limits of agreement on top of the existing scatter plot.</p>
<p>The parameter <code>lty = 3</code> used with the <code>lines()</code> function specifies dotted lines.</p>
<p><code>R</code> provided a great number of graphical parameters that can be used to customise plots. You can see a list of
these parameters using:</p>
<pre class="sourceCode r" id="cb536"><code class="sourceCode r"><a class="sourceLine" id="cb536-1" data-line-number="1"><span class="kw">help</span>(par)</a></code></pre>
<p>These parameters can be specified for almost all graphical functions.</p>
<p>Lets try the <code>ba.plot()</code> function with the test data:</p>
<pre class="sourceCode r" id="cb537"><code class="sourceCode r"><a class="sourceLine" id="cb537-1" data-line-number="1"><span class="kw">ba.plot</span>(Wright, Mini, <span class="dt">title =</span>  <span class="st">&quot;Difference vs. mean for PEFR data&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-296-1.png" width="672" /></p>
<p>The function is almost complete. All that remains to do is to label the lines with the values of the mean difference and the limits of agreement.</p>
<p>Use the <code>fix()</code> function to edit the <code>ba.plot()</code> function:</p>
<pre class="sourceCode r" id="cb538"><code class="sourceCode r"><a class="sourceLine" id="cb538-1" data-line-number="1"><span class="kw">fix</span>(ba.plot)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb539"><code class="sourceCode r"><a class="sourceLine" id="cb539-1" data-line-number="1"><span class="cf">function</span>(a, b, <span class="dt">title =</span> <span class="st">&quot;Bland and Altman Plot&quot;</span>) {</a>
<a class="sourceLine" id="cb539-2" data-line-number="2">  a.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(a))</a>
<a class="sourceLine" id="cb539-3" data-line-number="3">  b.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(b))</a>
<a class="sourceLine" id="cb539-4" data-line-number="4">  x.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Mean of&quot;</span>, a.txt, <span class="st">&quot;and&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb539-5" data-line-number="5">  y.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(a.txt, <span class="st">&quot;-&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb539-6" data-line-number="6">  mean.two &lt;-<span class="st"> </span>(a <span class="op">+</span><span class="st"> </span>b) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb539-7" data-line-number="7">  diff.two &lt;-<span class="st"> </span>a <span class="op">-</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb539-8" data-line-number="8">  <span class="kw">plot</span>(mean.two, diff.two, <span class="dt">xlab =</span> x.lab, <span class="dt">ylab =</span> y.lab, <span class="dt">main =</span> title) </a>
<a class="sourceLine" id="cb539-9" data-line-number="9">  mean.diff &lt;-<span class="st"> </span><span class="kw">mean</span>(diff.two)</a>
<a class="sourceLine" id="cb539-10" data-line-number="10">  sd.diff &lt;-<span class="st"> </span><span class="kw">sd</span>(diff.two)</a>
<a class="sourceLine" id="cb539-11" data-line-number="11">  upper &lt;-<span class="st"> </span>mean.diff <span class="op">+</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>sd.diff</a>
<a class="sourceLine" id="cb539-12" data-line-number="12">  lower &lt;-<span class="st"> </span>mean.diff <span class="op">-</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>sd.diff</a>
<a class="sourceLine" id="cb539-13" data-line-number="13">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(mean.diff, mean.diff), <span class="dt">lty =</span> <span class="dv">3</span>) </a>
<a class="sourceLine" id="cb539-14" data-line-number="14">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(upper, upper), <span class="dt">lty =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb539-15" data-line-number="15">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(lower, lower), <span class="dt">lty =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb539-16" data-line-number="16">  m.text &lt;-<span class="st"> </span><span class="kw">round</span>(mean.diff, <span class="dt">digits =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb539-17" data-line-number="17">  u.text &lt;-<span class="st"> </span><span class="kw">round</span>(upper , <span class="dt">digits =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb539-18" data-line-number="18">  l.text &lt;-<span class="st"> </span><span class="kw">round</span>(lower, <span class="dt">digits =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb539-19" data-line-number="19">  <span class="kw">text</span>(<span class="kw">max</span>(mean.two), mean.diff, m.text, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)) </a>
<a class="sourceLine" id="cb539-20" data-line-number="20">  <span class="kw">text</span>(<span class="kw">max</span>(mean.two), upper, u.text, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)) </a>
<a class="sourceLine" id="cb539-21" data-line-number="21">  <span class="kw">text</span>(<span class="kw">max</span>(mean.two), lower, l.text, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb539-22" data-line-number="22">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.
We have used the <code>round()</code> function to limit the display of the mean difference and the limits of agreement to one decimal place and used the <code>text()</code> function to display these (rounded) values. The <code>adj</code> parameter to the <code>text()</code> function controls the position and justification of text.</p>
<p>Let’s try the <code>ba.plot()</code> function with the test data:</p>
<pre class="sourceCode r" id="cb540"><code class="sourceCode r"><a class="sourceLine" id="cb540-1" data-line-number="1"><span class="kw">ba.plot</span>(Wright, Mini, <span class="dt">title =</span> <span class="st">&quot;PEFR data&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-300-1.png" width="672" /></p>
<p>The graphical function is now complete.</p>
<p>One improvement that we could make is for the function to produce a chart and return the values of the mean difference and the limits of agreement.</p>
<p>We would do this in exactly the same way as we would with a non-graphical function. We would return the mean difference and the limits of agreement as members of a list.</p>
<p>We could also specify a class for the returned list and create a class specific <code>print()</code> function (or <em>method</em>) to produce nicely formatted output.</p>
<p>Use the <code>fix()</code> function to edit the <code>ba.plot()</code> function:</p>
<pre class="sourceCode r" id="cb541"><code class="sourceCode r"><a class="sourceLine" id="cb541-1" data-line-number="1"><span class="kw">fix</span>(ba.plot)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb542"><code class="sourceCode r"><a class="sourceLine" id="cb542-1" data-line-number="1"><span class="cf">function</span>(a, b, <span class="dt">title =</span> <span class="st">&quot;Bland and Altman Plot&quot;</span>) {</a>
<a class="sourceLine" id="cb542-2" data-line-number="2">  a.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(a))</a>
<a class="sourceLine" id="cb542-3" data-line-number="3">  b.txt &lt;-<span class="st"> </span><span class="kw">deparse</span>(<span class="kw">substitute</span>(b))</a>
<a class="sourceLine" id="cb542-4" data-line-number="4">  x.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="st">&quot;Mean of&quot;</span>, a.txt, <span class="st">&quot;and&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb542-5" data-line-number="5">  y.lab &lt;-<span class="st"> </span><span class="kw">paste</span>(a.txt, <span class="st">&quot;-&quot;</span>, b.txt)</a>
<a class="sourceLine" id="cb542-6" data-line-number="6">  mean.two &lt;-<span class="st"> </span>(a <span class="op">+</span><span class="st"> </span>b) <span class="op">/</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb542-7" data-line-number="7">  diff.two &lt;-<span class="st"> </span>a <span class="op">-</span><span class="st"> </span>b</a>
<a class="sourceLine" id="cb542-8" data-line-number="8">  <span class="kw">plot</span>(mean.two, diff.two, <span class="dt">xlab =</span> x.lab, <span class="dt">ylab =</span> y.lab, <span class="dt">main =</span> title) </a>
<a class="sourceLine" id="cb542-9" data-line-number="9">  mean.diff &lt;-<span class="st"> </span><span class="kw">mean</span>(diff.two)</a>
<a class="sourceLine" id="cb542-10" data-line-number="10">  sd.diff &lt;-<span class="st"> </span><span class="kw">sd</span>(diff.two)</a>
<a class="sourceLine" id="cb542-11" data-line-number="11">  upper &lt;-<span class="st"> </span>mean.diff <span class="op">+</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>sd.diff</a>
<a class="sourceLine" id="cb542-12" data-line-number="12">  lower &lt;-<span class="st"> </span>mean.diff <span class="op">-</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>sd.diff</a>
<a class="sourceLine" id="cb542-13" data-line-number="13">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(mean.diff, mean.diff), <span class="dt">lty =</span> <span class="dv">3</span>) </a>
<a class="sourceLine" id="cb542-14" data-line-number="14">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(upper, upper), <span class="dt">lty =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb542-15" data-line-number="15">  <span class="kw">lines</span>(<span class="dt">x =</span> <span class="kw">range</span>(mean.two), <span class="dt">y =</span> <span class="kw">c</span>(lower, lower), <span class="dt">lty =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb542-16" data-line-number="16">  m.text &lt;-<span class="st"> </span><span class="kw">round</span>(mean.diff, <span class="dt">digits =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb542-17" data-line-number="17">  u.text &lt;-<span class="st"> </span><span class="kw">round</span>(upper , <span class="dt">digits =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb542-18" data-line-number="18">  l.text &lt;-<span class="st"> </span><span class="kw">round</span>(lower, <span class="dt">digits =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb542-19" data-line-number="19">  <span class="kw">text</span>(<span class="kw">max</span>(mean.two), mean.diff, m.text, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)) </a>
<a class="sourceLine" id="cb542-20" data-line-number="20">  <span class="kw">text</span>(<span class="kw">max</span>(mean.two), upper, u.text, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>)) </a>
<a class="sourceLine" id="cb542-21" data-line-number="21">  <span class="kw">text</span>(<span class="kw">max</span>(mean.two), lower, l.text, <span class="dt">adj =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb542-22" data-line-number="22">  ba &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">mean =</span> mean.diff, <span class="dt">limits =</span> <span class="kw">c</span>(lower, upper))</a>
<a class="sourceLine" id="cb542-23" data-line-number="23">  <span class="kw">class</span>(ba) &lt;-<span class="st"> &quot;ba&quot;</span></a>
<a class="sourceLine" id="cb542-24" data-line-number="24">  <span class="kw">return</span>(ba)</a>
<a class="sourceLine" id="cb542-25" data-line-number="25">}</a></code></pre>
<p>Once you have made the changes shown above, save the file and quit the editor.</p>
<p>Create a <code>print()</code> function for objects of the <code>ba</code> class:</p>
<pre class="sourceCode r" id="cb543"><code class="sourceCode r"><a class="sourceLine" id="cb543-1" data-line-number="1">print.ba &lt;-<span class="st"> </span><span class="cf">function</span>(x) {}</a></code></pre>
<p>Use the <code>fix()</code> function to edit the new function:</p>
<pre class="sourceCode r" id="cb544"><code class="sourceCode r"><a class="sourceLine" id="cb544-1" data-line-number="1"><span class="kw">fix</span>(print.ba)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb545"><code class="sourceCode r"><a class="sourceLine" id="cb545-1" data-line-number="1"><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb545-2" data-line-number="2">  <span class="kw">cat</span>(<span class="st">&quot;Mean difference     : &quot;</span>, x<span class="op">$</span>mean, <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb545-3" data-line-number="3">      <span class="st">&quot;Limits of agreement : &quot;</span>, x<span class="op">$</span>limits[<span class="dv">1</span>], <span class="st">&quot;; &quot;</span>, x<span class="op">$</span>limits[<span class="dv">2</span>], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb545-4" data-line-number="4">      <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb545-5" data-line-number="5">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>Let’s try the <code>ba.plot()</code> function with the test data:</p>
<pre class="sourceCode r" id="cb546"><code class="sourceCode r"><a class="sourceLine" id="cb546-1" data-line-number="1"><span class="kw">ba.plot</span>(Wright, Mini, <span class="dt">title =</span> <span class="st">&quot;PEFR data&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-308-1.png" width="672" /></p>
<pre><code>## Mean difference     : -2.117647
## Limits of agreement : -78.0973; 73.86201</code></pre>
<p>The function produces the plot and returns the mean difference and limits of agreement as a list of class <code>ba</code> which is formatted and printed by the <code>print.ba()</code> function.</p>
<p>We can manipulate the returned values just as we would with any other function:</p>
<pre class="sourceCode r" id="cb548"><code class="sourceCode r"><a class="sourceLine" id="cb548-1" data-line-number="1">ba.test &lt;-<span class="st"> </span><span class="kw">ba.plot</span>(Wright, Mini)</a>
<a class="sourceLine" id="cb548-2" data-line-number="2"><span class="kw">print</span>(ba.test)</a>
<a class="sourceLine" id="cb548-3" data-line-number="3">ba.test</a>
<a class="sourceLine" id="cb548-4" data-line-number="4">ba.test<span class="op">$</span>mean</a>
<a class="sourceLine" id="cb548-5" data-line-number="5">ba.test<span class="op">$</span>limits</a>
<a class="sourceLine" id="cb548-6" data-line-number="6">ba.test<span class="op">$</span>limits[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb548-7" data-line-number="7">ba.test<span class="op">$</span>limits[<span class="dv">2</span>]</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-310-1.png" width="672" /></p>
<pre><code>## Mean difference     : -2.117647
## Limits of agreement : -78.0973; 73.86201</code></pre>
<pre><code>## Mean difference     : -2.117647
## Limits of agreement : -78.0973; 73.86201</code></pre>
<pre><code>## [1] -2.117647</code></pre>
<pre><code>## [1] -78.09730  73.86201</code></pre>
<pre><code>## [1] -78.0973</code></pre>
<pre><code>## [1] 73.86201</code></pre>
<p>You might like to use the <code>save()</code> function to save the <code>ba.plot()</code> and <code>print.ba()</code> functions before quitting <code>R</code>.</p>
<p>We can now quit <code>R</code>:</p>
<pre class="sourceCode r" id="cb555"><code class="sourceCode r"><a class="sourceLine" id="cb555-1" data-line-number="1"><span class="kw">q</span>()</a></code></pre>
<p>For this exercise there is no need to save the workspace image so click the <strong>No</strong> or <strong>Don’t Save</strong> button (GUI) or enter <code>n</code> when prompted to save the workspace image (terminal).</p>
<div id="summary-6" class="section level2">
<h2><span class="header-section-number">7.1</span> Summary</h2>
<ul>
<li><p><code>R</code> allows you to create functions that produce graphical output.</p></li>
<li><p><code>R</code> allows you to create functions that produce graphical output and return values.</p></li>
<li><p><code>R</code> objects can be assigned a class or type.</p></li>
<li><p><code>R</code> allows you to create new classes and class-specific functions that can extract and manipulate data common to the new classes.</p></li>
<li><p>Classes allows you to create versatile functions that return values when we need them to return values but can also produce formatted output when we need them to produce formatted output.</p></li>
<li><p>Classes allow you to write functions that can be chained together so that the output of one function is the input of another function.</p></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exercise6.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="exercise8.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["prfe.pdf", "prfe.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
