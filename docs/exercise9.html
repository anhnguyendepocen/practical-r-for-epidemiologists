<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Practical R for Epidemiologists</title>
  <meta name="description" content="This guide is intended as a practical introduction to using the R environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending R using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g. calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications. If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider purchasing this book.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Practical R for Epidemiologists" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://guevarra.io/practical-r-for-epidemiologists/" />
  <meta property="og:image" content="https://guevarra.io/practical-r-for-epidemiologists/images/bookcover.jpg" />
  <meta property="og:description" content="This guide is intended as a practical introduction to using the R environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending R using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g. calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications. If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider purchasing this book." />
  <meta name="github-repo" content="ernestguevarra/practical-r-for-epidemiologists" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Practical R for Epidemiologists" />
  
  <meta name="twitter:description" content="This guide is intended as a practical introduction to using the R environment for data analysis and graphics to work with epidemiological data. Topics covered include univariate statistics, simple statistical inference, charting data, two-by-two tables, stratified analysis, chi-square test for trend, logistic regression, survival analysis, computer-intensive methods, and extending R using user-provided functions. You should be able to follow the material if you are reasonably familiar with the mechanics of statistical estimation (e.g. calculation of odds ratios and confidence intervals) and require a system that can perform simple or complex analyses to your exact specifications. If you are interested in a system that is flexible, can be tailored to produce exactly the analysis you want, provides modern analytical facilities, and have a basic understanding of the mechanics of hypothesis testing and estimation then you should consider purchasing this book." />
  <meta name="twitter:image" content="https://guevarra.io/practical-r-for-epidemiologists/images/bookcover.jpg" />

<meta name="author" content="Mark Myatt and Ernest Guevarra">


<meta name="date" content="2018-05-11">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="exercise8.html">
<link rel="next" href="what-now.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />







<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-118912078-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-118912078-1');
</script>


<style type="text/css">
a.sourceLine { display: inline-block; min-height: 1.25em; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; }
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
pre, code { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; color: initial; }
}
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.bn { color: #0000cf; } /* BaseN */
code span.fl { color: #0000cf; } /* Float */
code span.ch { color: #4e9a06; } /* Char */
code span.st { color: #4e9a06; } /* String */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.ot { color: #8f5902; } /* Other */
code span.al { color: #ef2929; } /* Alert */
code span.fu { color: #000000; } /* Function */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code span.cn { color: #000000; } /* Constant */
code span.sc { color: #000000; } /* SpecialChar */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.im { } /* Import */
code span.va { color: #000000; } /* Variable */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.ex { } /* Extension */
code span.at { color: #c4a000; } /* Attribute */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Practical R for Epidemiologists</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="introducing-r.html"><a href="introducing-r.html"><i class="fa fa-check"></i>Introducing R</a><ul>
<li class="chapter" data-level="" data-path="introducing-r.html"><a href="introducing-r.html#retrieving-data"><i class="fa fa-check"></i>Retrieving data</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="exercise1.html"><a href="exercise1.html"><i class="fa fa-check"></i><b>1</b> Getting acquainted with R</a><ul>
<li class="chapter" data-level="1.1" data-path="exercise1.html"><a href="exercise1.html#summary"><i class="fa fa-check"></i><b>1.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="exercise2.html"><a href="exercise2.html"><i class="fa fa-check"></i><b>2</b> Manipulating objects and creating new functions</a><ul>
<li class="chapter" data-level="2.1" data-path="exercise2.html"><a href="exercise2.html#summary-1"><i class="fa fa-check"></i><b>2.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="exercise3.html"><a href="exercise3.html"><i class="fa fa-check"></i><b>3</b> Logistic regression and stratified analysis</a><ul>
<li class="chapter" data-level="3.1" data-path="exercise3.html"><a href="exercise3.html#matched-data"><i class="fa fa-check"></i><b>3.1</b> Matched data</a></li>
<li class="chapter" data-level="3.2" data-path="exercise3.html"><a href="exercise3.html#summary-2"><i class="fa fa-check"></i><b>3.2</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="exercise4.html"><a href="exercise4.html"><i class="fa fa-check"></i><b>4</b> Analysing some data with R</a><ul>
<li class="chapter" data-level="4.1" data-path="exercise4.html"><a href="exercise4.html#summary-3"><i class="fa fa-check"></i><b>4.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="exercise5.html"><a href="exercise5.html"><i class="fa fa-check"></i><b>5</b> Extending R with packages</a><ul>
<li class="chapter" data-level="5.1" data-path="exercise5.html"><a href="exercise5.html#summary-4"><i class="fa fa-check"></i><b>5.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exercise6.html"><a href="exercise6.html"><i class="fa fa-check"></i><b>6</b> Making your own objects behave like R objects</a><ul>
<li class="chapter" data-level="6.1" data-path="exercise6.html"><a href="exercise6.html#summary-5"><i class="fa fa-check"></i><b>6.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="exercise7.html"><a href="exercise7.html"><i class="fa fa-check"></i><b>7</b> Writing your own graphical functions</a><ul>
<li class="chapter" data-level="7.1" data-path="exercise7.html"><a href="exercise7.html#summary-6"><i class="fa fa-check"></i><b>7.1</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="exercise8.html"><a href="exercise8.html"><i class="fa fa-check"></i><b>8</b> More graphical functions</a><ul>
<li class="chapter" data-level="8.1" data-path="exercise8.html"><a href="exercise8.html#population-pyramid"><i class="fa fa-check"></i><b>8.1</b> Population pyramid</a></li>
<li class="chapter" data-level="8.2" data-path="exercise8.html"><a href="exercise8.html#pareto-chart"><i class="fa fa-check"></i><b>8.2</b> Pareto chart</a></li>
<li class="chapter" data-level="8.3" data-path="exercise8.html"><a href="exercise8.html#adding-confidence-intervals-or-error-bars-on-plots"><i class="fa fa-check"></i><b>8.3</b> Adding confidence intervals or error bars on plots</a></li>
<li class="chapter" data-level="8.4" data-path="exercise8.html"><a href="exercise8.html#mesh-map"><i class="fa fa-check"></i><b>8.4</b> Mesh map</a></li>
<li class="chapter" data-level="8.5" data-path="exercise8.html"><a href="exercise8.html#combining-plots"><i class="fa fa-check"></i><b>8.5</b> Combining plots</a></li>
<li class="chapter" data-level="8.6" data-path="exercise8.html"><a href="exercise8.html#summary-7"><i class="fa fa-check"></i><b>8.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="exercise9.html"><a href="exercise9.html"><i class="fa fa-check"></i><b>9</b> Computer intensive methods</a><ul>
<li class="chapter" data-level="9.1" data-path="exercise9.html"><a href="exercise9.html#estimation"><i class="fa fa-check"></i><b>9.1</b> Estimation</a></li>
<li class="chapter" data-level="9.2" data-path="exercise9.html"><a href="exercise9.html#hypothesis-testing"><i class="fa fa-check"></i><b>9.2</b> Hypothesis testing</a></li>
<li class="chapter" data-level="9.3" data-path="exercise9.html"><a href="exercise9.html#simulating-processes"><i class="fa fa-check"></i><b>9.3</b> Simulating processes</a></li>
<li class="chapter" data-level="9.4" data-path="exercise9.html"><a href="exercise9.html#cellular-automata-machines"><i class="fa fa-check"></i><b>9.4</b> Cellular automata machines</a></li>
<li class="chapter" data-level="9.5" data-path="exercise9.html"><a href="exercise9.html#summary-8"><i class="fa fa-check"></i><b>9.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="what-now.html"><a href="what-now.html"><i class="fa fa-check"></i>What now?</a></li>
<li class="divider"></li>
<li>&nbsp; &nbsp; @ Mark Myatt and Ernest Guevarra 2018</li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Practical R for Epidemiologists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="exercise9" class="section level1">
<h1><span class="header-section-number">Exercise 9</span> Computer intensive methods</h1>
<div id="estimation" class="section level2">
<h2><span class="header-section-number">9.1</span> Estimation</h2>
<p>Estimation involves the calculation of a measure with some sense of precision based upon sampling variation.</p>
<p>Only a few estimators (e.g. the sample mean from a normal population) have exact formulae that may be used to estimate sampling variation. Typically, estimates of variability are based upon approximations informed by expected or postulated properties of the sampled population. The development of variance formulae for some measures may require in-depth statistical and mathematical knowledge or may even be impossible to derive.</p>
<p><em>Bootstrap</em> methods are computer-intensive methods that can provide estimates and measures of precision (e.g. confidence intervals) without resort to theoretical models, higher mathematics, or assumptions about the sampled population. They rely on repeated sampling, sometimes called <em>resampling</em>, of the observed data.</p>
<p>As a simple example of how such methods work, we will start by using bootstrap methods to estimate the mean from a normal population. We will work with a very simple dataset which we will enter directly:</p>
<pre class="sourceCode r" id="cb675"><code class="sourceCode r"><a class="sourceLine" id="cb675-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">7.3</span>, <span class="fl">10.4</span>, <span class="fl">14.0</span>, <span class="fl">12.2</span>, <span class="fl">8.4</span>)</a></code></pre>
<p>We can summarise this data quite easily:</p>
<pre class="sourceCode r" id="cb676"><code class="sourceCode r"><a class="sourceLine" id="cb676-1" data-line-number="1"><span class="kw">mean</span>(x)</a></code></pre>
<pre><code>## [1] 10.46</code></pre>
<p>The <code>sample()</code> function can be used to select a bootstrap <code>replicate</code>:</p>
<pre class="sourceCode r" id="cb678"><code class="sourceCode r"><a class="sourceLine" id="cb678-1" data-line-number="1"><span class="kw">sample</span>(x, <span class="kw">length</span>(x), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a></code></pre>
<pre><code>## [1] 14.0  7.3 10.4 12.2  8.4</code></pre>
<p>Enter this command several times to see some more bootstrap replicates. Remember that previous commands can be recalled and edited using the up and down arrow keys – they do not need to be typed out in full each time. The <code>length()</code> parameter is not required for taking bootstrap replicates and can be omitted.</p>
<p>It is possible to apply a summary measure to a replicate:</p>
<pre class="sourceCode r" id="cb680"><code class="sourceCode r"><a class="sourceLine" id="cb680-1" data-line-number="1"><span class="kw">mean</span>(<span class="kw">sample</span>(x, <span class="dt">replace =</span> <span class="ot">TRUE</span>))</a></code></pre>
<pre><code>## [1] 12.3</code></pre>
<p>Enter this command several times. A bootstrap estimate of the mean of <code>x</code> can be made by repeating this process many times and taking the <code>median</code> of the means for each replicate.</p>
<p>One way of doing this is to create a matrix where each column contains a bootstrap replicate and then use the <code>apply()</code> and <code>mean()</code> functions to get at the estimate.</p>
<p>First create the matrix of replicates. Here we take ten replicates:</p>
<pre class="sourceCode r" id="cb682"><code class="sourceCode r"><a class="sourceLine" id="cb682-1" data-line-number="1">x1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">sample</span>(x, <span class="kw">length</span>(x) <span class="op">*</span><span class="st"> </span><span class="dv">10</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb682-2" data-line-number="2">             <span class="dt">nrow =</span> <span class="kw">length</span>(x), <span class="dt">ncol =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb682-3" data-line-number="3">x1</a></code></pre>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]  8.4 12.2 12.2  7.3  7.3  7.3  7.3 12.2 12.2   7.3
## [2,] 10.4 10.4  8.4  7.3 10.4 14.0 12.2  7.3  8.4   8.4
## [3,]  7.3  8.4 12.2 10.4 14.0 14.0  7.3  8.4 14.0   7.3
## [4,] 14.0  8.4 14.0 14.0 10.4 12.2 12.2  8.4 12.2  12.2
## [5,]  8.4 14.0  7.3  7.3 14.0 10.4  7.3  8.4 14.0  12.2</code></pre>
<p>Then calculate and store the means of each replicate. We can do this using the <code>apply()</code> function to apply the <code>mean()</code> function to the columns of matrix <code>x1</code>:</p>
<pre class="sourceCode r" id="cb684"><code class="sourceCode r"><a class="sourceLine" id="cb684-1" data-line-number="1">x2 &lt;-<span class="st"> </span><span class="kw">apply</span>(x1, <span class="dv">2</span>, mean)</a>
<a class="sourceLine" id="cb684-2" data-line-number="2">x2</a></code></pre>
<pre><code>##  [1]  9.70 10.68 10.82  9.26 11.22 11.58  9.26  8.94 12.16  9.48</code></pre>
<p>The bootstrap estimate of the mean is:</p>
<pre class="sourceCode r" id="cb686"><code class="sourceCode r"><a class="sourceLine" id="cb686-1" data-line-number="1"><span class="kw">median</span>(x2)</a></code></pre>
<pre><code>## [1] 10.19</code></pre>
<p>The bootstrap estimate may differ somewhat from the mean of <code>x</code>:</p>
<pre class="sourceCode r" id="cb688"><code class="sourceCode r"><a class="sourceLine" id="cb688-1" data-line-number="1"><span class="kw">mean</span>(x)</a></code></pre>
<pre><code>## [1] 10.46</code></pre>
<p>The situation is improved by increasing the number of replicates. Here we take 5000 replicates:</p>
<pre class="sourceCode r" id="cb690"><code class="sourceCode r"><a class="sourceLine" id="cb690-1" data-line-number="1">x1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">sample</span>(x, <span class="kw">length</span>(x) <span class="op">*</span><span class="st"> </span><span class="dv">5000</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb690-2" data-line-number="2">             <span class="dt">nrow =</span> <span class="kw">length</span>(x), <span class="dt">ncol =</span> <span class="dv">5000</span>)</a>
<a class="sourceLine" id="cb690-3" data-line-number="3">x2 &lt;-<span class="st"> </span><span class="kw">apply</span>(x1, <span class="dv">2</span>, mean)</a>
<a class="sourceLine" id="cb690-4" data-line-number="4"><span class="kw">median</span>(x2)</a></code></pre>
<pre><code>## [1] 10.46</code></pre>
<p>This is a pretty useless example as estimating the mean / standard deviation, or standard error of the mean of a sample from a normal population can be done using standard formulae.</p>
<p>The utility of bootstrap methods is that they can be applied to summary measures that are not as well understood as the arithmetic mean. The bootstrap method also has the advantage of retaining simplicity even with complicated measures.</p>
<p>To illustrate this, we will work through an example of using the bootstrap to estimate the harmonic mean.</p>
<p>Again, we will work with a simple dataset which we will enter directly:</p>
<pre class="sourceCode r" id="cb692"><code class="sourceCode r"><a class="sourceLine" id="cb692-1" data-line-number="1">d &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">43.64</span>, <span class="fl">50.67</span>, <span class="fl">33.56</span>, <span class="fl">27.75</span>, <span class="fl">43.35</span>, <span class="fl">29.56</span>, <span class="fl">38.83</span>, <span class="fl">35.95</span>, <span class="fl">20.01</span>)</a></code></pre>
<p>The data represents distance (in kilometres) from a point source of environmental pollution for nine female patients with oral / pharyngeal cancer.</p>
<p>The harmonic mean is considered to be a sensitive measure of spatial clustering. The first step is to construct a function to calculate the harmonic mean:</p>
<pre class="sourceCode r" id="cb693"><code class="sourceCode r"><a class="sourceLine" id="cb693-1" data-line-number="1">h.mean &lt;-<span class="st"> </span><span class="cf">function</span>(x) {<span class="kw">length</span>(x) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>x)}</a></code></pre>
<p>Calling this function with the sample data:</p>
<pre class="sourceCode r" id="cb694"><code class="sourceCode r"><a class="sourceLine" id="cb694-1" data-line-number="1"><span class="kw">h.mean</span>(d)</a></code></pre>
<pre><code>## [1] 33.46646</code></pre>
<p>Should return an estimated harmonic mean distance of 33.47 kilometres. This is simple. The problem is that calculating the variance of this estimate is complicated using standard methods. This problem is relatively simple to solve using bootstrap methods:</p>
<pre class="sourceCode r" id="cb696"><code class="sourceCode r"><a class="sourceLine" id="cb696-1" data-line-number="1">replicates &lt;-<span class="st"> </span><span class="dv">5000</span></a>
<a class="sourceLine" id="cb696-2" data-line-number="2">n &lt;-<span class="st"> </span><span class="kw">length</span>(d)</a>
<a class="sourceLine" id="cb696-3" data-line-number="3">x1 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">sample</span>(d, n <span class="op">*</span><span class="st"> </span>replicates, <span class="dt">replace =</span> <span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb696-4" data-line-number="4">             <span class="dt">nrow =</span> n, <span class="dt">ncol =</span> replicates)</a>
<a class="sourceLine" id="cb696-5" data-line-number="5">x2 &lt;-<span class="st"> </span><span class="kw">apply</span>(x1, <span class="dv">2</span>, h.mean)</a>
<a class="sourceLine" id="cb696-6" data-line-number="6"><span class="kw">median</span>(x2)</a></code></pre>
<pre><code>## [1] 33.74181</code></pre>
<p>A 95% confidence interval can be extracted from <code>x2</code> using the <code>quantile()</code> function:</p>
<pre class="sourceCode r" id="cb698"><code class="sourceCode r"><a class="sourceLine" id="cb698-1" data-line-number="1"><span class="kw">quantile</span>(x2, <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</a></code></pre>
<pre><code>##     2.5%    97.5% 
## 27.78796 40.43014</code></pre>
<p>A 99% confidence interval can also be extracted from <code>x2</code> using the <code>quantile()</code> function:</p>
<pre class="sourceCode r" id="cb700"><code class="sourceCode r"><a class="sourceLine" id="cb700-1" data-line-number="1"><span class="kw">quantile</span>(x2, <span class="kw">c</span>(<span class="fl">0.005</span>, <span class="fl">0.995</span>))</a></code></pre>
<pre><code>##     0.5%    99.5% 
## 26.39237 42.35583</code></pre>
<p>As a final example of the bootstrap method we will use the method to obtain an estimate of an odds ratio from a two-by-two table. We will work with the <code>salex</code> dataset which we used in exercise 2 and exercise 3:</p>
<pre class="sourceCode r" id="cb702"><code class="sourceCode r"><a class="sourceLine" id="cb702-1" data-line-number="1">salex &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;salex.dat&quot;</span>,  <span class="dt">header =</span> <span class="ot">TRUE</span>, <span class="dt">na.strings =</span> <span class="st">&quot;9&quot;</span>)</a>
<a class="sourceLine" id="cb702-2" data-line-number="2"><span class="kw">table</span>(salex<span class="op">$</span>EGGS, salex<span class="op">$</span>ILL)</a></code></pre>
<pre><code>##    
##      1  2
##   1 40  6
##   2 10 20</code></pre>
<p>We should set up our estimator function to calculate an odds ratio from a two-by-two table:</p>
<pre class="sourceCode r" id="cb704"><code class="sourceCode r"><a class="sourceLine" id="cb704-1" data-line-number="1">or &lt;-<span class="st"> </span><span class="cf">function</span>(x) {(x[<span class="dv">1</span>,<span class="dv">1</span>] <span class="op">/</span><span class="st"> </span>x[<span class="dv">1</span>,<span class="dv">2</span>]) <span class="op">/</span><span class="st"> </span>(x[<span class="dv">2</span>,<span class="dv">1</span>] <span class="op">/</span><span class="st"> </span>x[<span class="dv">2</span>,<span class="dv">2</span>])}</a></code></pre>
<p>We should test this:</p>
<pre class="sourceCode r" id="cb705"><code class="sourceCode r"><a class="sourceLine" id="cb705-1" data-line-number="1"><span class="kw">or</span>(<span class="kw">table</span>(salex<span class="op">$</span>EGGS, salex<span class="op">$</span>ILL))</a></code></pre>
<pre><code>## [1] 13.33333</code></pre>
<p>The problem is to take a bootstrap replicate from two vectors in a data.frame. This can be achieved by using <code>sample()</code> to create a vector of row indices and then use this sample of indices to select replicates from the data.frame:</p>
<pre class="sourceCode r" id="cb707"><code class="sourceCode r"><a class="sourceLine" id="cb707-1" data-line-number="1">boot &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb707-2" data-line-number="2"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>) {</a>
<a class="sourceLine" id="cb707-3" data-line-number="3">  sampled.rows &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(salex), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb707-4" data-line-number="4">  x &lt;-<span class="st"> </span>salex[sampled.rows, <span class="st">&quot;EGGS&quot;</span>]</a>
<a class="sourceLine" id="cb707-5" data-line-number="5">  y &lt;-<span class="st"> </span>salex[sampled.rows, <span class="st">&quot;ILL&quot;</span>]</a>
<a class="sourceLine" id="cb707-6" data-line-number="6">  boot[i] &lt;-<span class="st"> </span><span class="kw">or</span>(<span class="kw">table</span>(x, y))</a>
<a class="sourceLine" id="cb707-7" data-line-number="7">}</a></code></pre>
<p>The vector <code>boot</code> now contains the odds ratios calculated from 1000 replicates. Estimates of the odds ratio and its 95% confidence interval may be obtained using the <code>median()</code> and <code>quantile()</code> functions</p>
<pre class="sourceCode r" id="cb708"><code class="sourceCode r"><a class="sourceLine" id="cb708-1" data-line-number="1"><span class="kw">median</span>(boot)</a>
<a class="sourceLine" id="cb708-2" data-line-number="2"><span class="kw">quantile</span>(boot, <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</a></code></pre>
<pre><code>## [1] 14.08398</code></pre>
<pre><code>##      2.5%     97.5% 
##  4.931875 60.084375</code></pre>
<p>This approach may fail when some tables have cells that contain zero. Infinite values arise due to division by zero when calculating the odds ratio for some replicates. We can avoid this problem by selecting only those values of <code>boot</code> that are not (<code>!=</code>) infinite (<code>Inf</code>):</p>
<pre class="sourceCode r" id="cb711"><code class="sourceCode r"><a class="sourceLine" id="cb711-1" data-line-number="1">boot &lt;-<span class="st"> </span>boot[boot <span class="op">!=</span><span class="st"> </span><span class="ot">Inf</span>]</a>
<a class="sourceLine" id="cb711-2" data-line-number="2"><span class="kw">median</span>(boot)</a>
<a class="sourceLine" id="cb711-3" data-line-number="3"><span class="kw">quantile</span>(boot, <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</a></code></pre>
<pre><code>## [1] 14.07273</code></pre>
<pre><code>##      2.5%     97.5% 
##  4.930417 59.168750</code></pre>
<p>Another way to avoid this problem is to use an <code>adjusted odds ratio</code> calculated by adding 0.5 to each cell of the two-by-two table:</p>
<pre class="sourceCode r" id="cb714"><code class="sourceCode r"><a class="sourceLine" id="cb714-1" data-line-number="1">boot &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb714-2" data-line-number="2"><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">1000</span>) {</a>
<a class="sourceLine" id="cb714-3" data-line-number="3">  sampled.rows &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(salex), <span class="dt">replace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb714-4" data-line-number="4">  x &lt;-<span class="st"> </span>salex[sampled.rows, <span class="st">&quot;EGGS&quot;</span>]</a>
<a class="sourceLine" id="cb714-5" data-line-number="5">  y &lt;-<span class="st"> </span>salex[sampled.rows, <span class="st">&quot;ILL&quot;</span>]</a>
<a class="sourceLine" id="cb714-6" data-line-number="6">  boot[i] &lt;-<span class="st"> </span><span class="kw">or</span>(<span class="kw">table</span>(x, y) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>)</a>
<a class="sourceLine" id="cb714-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb714-8" data-line-number="8"><span class="kw">median</span>(boot)</a>
<a class="sourceLine" id="cb714-9" data-line-number="9"><span class="kw">quantile</span>(boot, <span class="kw">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>))</a></code></pre>
<pre><code>## [1] 12.48126</code></pre>
<pre><code>##      2.5%     97.5% 
##  4.782361 44.514706</code></pre>
<p>This procedure is preferred when working with sparse tables.</p>
</div>
<div id="hypothesis-testing" class="section level2">
<h2><span class="header-section-number">9.2</span> Hypothesis testing</h2>
<p>Computer-intensive methods also offer a general approach to statistical hypothesis testing. To illustrate this we will use <em>computer based simulation</em> to investigate spatial clustering around a point.</p>
<p>Before continuing, we will retrieve a dataset:</p>
<pre class="sourceCode r" id="cb717"><code class="sourceCode r"><a class="sourceLine" id="cb717-1" data-line-number="1">waste &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;waste.dat&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a></code></pre>
<p>The file <code>waste.dat</code> contains the location of twenty-three recent cases of childhood cancer in 5 by 5 km square surrounding an industrial waste disposal site. The columns in the dataset are:</p>
<table style="width:58%;">
<colgroup>
<col width="15%" />
<col width="43%" />
</colgroup>
<tbody>
<tr class="odd">
<td><strong>x</strong></td>
<td>The x location of cases</td>
</tr>
<tr class="even">
<td><strong>y</strong></td>
<td>The y location of cases</td>
</tr>
</tbody>
</table>
<p>The <code>x</code> and <code>y</code> variables have been transformed to lie between 0 and 1 with the industrial waste disposal site centrally located (i.e. at <code>x</code> = 0.5, <code>y</code> = 0.5).</p>
<p>Plot the data and the location of the industrial waste disposal site on the same chart:</p>
<pre class="sourceCode r" id="cb718"><code class="sourceCode r"><a class="sourceLine" id="cb718-1" data-line-number="1"><span class="kw">plot</span>(waste<span class="op">$</span>x, waste<span class="op">$</span>y, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb718-2" data-line-number="2"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">pch =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-485-1.png" width="672" /></p>
<p>We can calculate the distance of each point from the industrial waste disposal site using Pythagoras’ Theorem:</p>
<pre class="sourceCode r" id="cb719"><code class="sourceCode r"><a class="sourceLine" id="cb719-1" data-line-number="1">distance.obs &lt;-<span class="st"> </span><span class="kw">sqrt</span>((waste<span class="op">$</span>x <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>(waste<span class="op">$</span>y <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)</a></code></pre>
<p>The observed mean distance or each case from the industrial waste disposal site is:</p>
<pre class="sourceCode r" id="cb720"><code class="sourceCode r"><a class="sourceLine" id="cb720-1" data-line-number="1"><span class="kw">mean</span>(distance.obs)</a></code></pre>
<pre><code>## [1] 0.3444118</code></pre>
<p>To test whether this distance is unlikely to have arisen by chance (i.e. evidence of spatial clustering) we need to simulate the distribution of distances when no spatial pattern exists:</p>
<pre class="sourceCode r" id="cb722"><code class="sourceCode r"><a class="sourceLine" id="cb722-1" data-line-number="1">r &lt;-<span class="st"> </span><span class="dv">10000</span></a>
<a class="sourceLine" id="cb722-2" data-line-number="2">x.sim &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(r <span class="op">*</span><span class="st"> </span><span class="dv">23</span>), <span class="dv">23</span>, r)</a>
<a class="sourceLine" id="cb722-3" data-line-number="3">y.sim &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(r <span class="op">*</span><span class="st"> </span><span class="dv">23</span>), <span class="dv">23</span>, r)</a>
<a class="sourceLine" id="cb722-4" data-line-number="4">distance.run &lt;-<span class="st"> </span><span class="kw">sqrt</span>((x.sim <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>(y.sim <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb722-5" data-line-number="5">distance.sim &lt;-<span class="st"> </span><span class="kw">apply</span>(distance.run, <span class="dv">2</span>, mean)</a>
<a class="sourceLine" id="cb722-6" data-line-number="6"><span class="kw">hist</span>(distance.sim, <span class="dt">breaks =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb722-7" data-line-number="7"><span class="kw">abline</span>(<span class="dt">v =</span> <span class="kw">mean</span>(distance.obs), <span class="dt">lty =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-488-1.png" width="672" /></p>
<p>The probability (i.e. the <em>p-value</em>) of observing a mean distance smaller than the <em>observed mean</em> distance under the null hypothesis can be estimated as the number of estimates of the mean distance under the null hypothesis falling below the observed mean divided by the total number of estimates of the mean distance under the null hypothesis:</p>
<pre class="sourceCode r" id="cb723"><code class="sourceCode r"><a class="sourceLine" id="cb723-1" data-line-number="1">m &lt;-<span class="st"> </span><span class="kw">mean</span>(distance.obs)</a>
<a class="sourceLine" id="cb723-2" data-line-number="2">z &lt;-<span class="st"> </span><span class="kw">ifelse</span>(distance.sim <span class="op">&lt;</span><span class="st"> </span>m, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb723-3" data-line-number="3"><span class="kw">sum</span>(z) <span class="op">/</span><span class="st"> </span>r</a></code></pre>
<pre><code>## [1] 0.106</code></pre>
<p>You might like to repeat this exercise using the harmonic mean distance and the median distance.</p>
<p>We can check if this method is capable of detecting a simple cluster using simulated data:</p>
<pre class="sourceCode r" id="cb725"><code class="sourceCode r"><a class="sourceLine" id="cb725-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">23</span>, <span class="dt">mean =</span> <span class="fl">0.5</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb725-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">23</span>, <span class="dt">mean =</span> <span class="fl">0.5</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb725-3" data-line-number="3"><span class="kw">plot</span>(x, y, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb725-4" data-line-number="4"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">pch =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-490-1.png" width="672" /></p>
<p>We need to recalculate the distance of each simulated case from the industrial waste disposal site:</p>
<pre class="sourceCode r" id="cb726"><code class="sourceCode r"><a class="sourceLine" id="cb726-1" data-line-number="1">distance.obs &lt;-<span class="st"> </span><span class="kw">sqrt</span>((x <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">^</span><span class="st"> </span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>(y <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>) <span class="op">^</span><span class="st"> </span><span class="dv">2</span>)</a></code></pre>
<p>The observed mean distance of each case from the industrial waste disposal site is:</p>
<pre class="sourceCode r" id="cb727"><code class="sourceCode r"><a class="sourceLine" id="cb727-1" data-line-number="1"><span class="kw">mean</span>(distance.obs)</a></code></pre>
<pre><code>## [1] 0.2534333</code></pre>
<p>We can use the the simulated null hypothesis data to test for spatial clustering:</p>
<pre class="sourceCode r" id="cb729"><code class="sourceCode r"><a class="sourceLine" id="cb729-1" data-line-number="1">m &lt;-<span class="st"> </span><span class="kw">mean</span>(distance.obs)</a>
<a class="sourceLine" id="cb729-2" data-line-number="2">z &lt;-<span class="st"> </span><span class="kw">ifelse</span>(distance.sim <span class="op">&lt;</span><span class="st"> </span>m, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb729-3" data-line-number="3"><span class="kw">sum</span>(z) <span class="op">/</span><span class="st"> </span>r</a></code></pre>
<pre><code>## [1] 0</code></pre>
<p>We should also check if the procedure can detect a plume of cases, such as might be created by a prevailing wind at a waste incineration site, in a similar way:</p>
<pre class="sourceCode r" id="cb731"><code class="sourceCode r"><a class="sourceLine" id="cb731-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">23</span>, <span class="fl">0.25</span>, <span class="fl">0.1</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb731-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">23</span>, <span class="fl">0.25</span>, <span class="fl">0.1</span>) <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb731-3" data-line-number="3"><span class="kw">plot</span>(x, y, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb731-4" data-line-number="4"><span class="kw">points</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="dt">pch =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-494-1.png" width="672" /></p>
<pre class="sourceCode r" id="cb732"><code class="sourceCode r"><a class="sourceLine" id="cb732-1" data-line-number="1">distance.obs &lt;-<span class="st"> </span><span class="kw">sqrt</span>((x <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>)<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>(y <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb732-2" data-line-number="2">m &lt;-<span class="st"> </span><span class="kw">mean</span>(distance.obs)</a>
<a class="sourceLine" id="cb732-3" data-line-number="3">z &lt;-<span class="st"> </span><span class="kw">ifelse</span>(distance.sim <span class="op">&lt;</span><span class="st"> </span>m, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb732-4" data-line-number="4"><span class="kw">sum</span>(z) <span class="op">/</span><span class="st"> </span>r</a></code></pre>
<pre><code>## [1] 0.4214</code></pre>
<p>The method is not capable of detecting plumes.</p>
<p>You might like to try adapting the simulation code presented here to provide a method capable of detecting plumes of cases.</p>
</div>
<div id="simulating-processes" class="section level2">
<h2><span class="header-section-number">9.3</span> Simulating processes</h2>
<p>In the previous example we simulated the expected distribution of data under the <em>null hypothesis</em>. Computer based simulations are not limited to simulating data. They can also be used to simulate processes.</p>
<p>In this example we will simulate the behaviour of the <em>lot quality assurance sampling</em> (LQAS) survey method when sampling constraints lead to a loss of sampling independence. In this example the sampling process is simulated and applied to real-world data.</p>
<p>LQAS is a small-sample classification technique that is widely used in manufacturing industry to judge the quality of a batch of manufactured items. In this context, LQAS is used to identify batches that are likely to contain an unacceptably large number of defective items. In the public health context, LQAS may be used to identify communities with unacceptably low levels of service (e.g. vaccine) coverage or worrying levels of disease prevalence.</p>
<p>The LQAS method produces data that is easy to analyse. Data analysis is performed as data is collected and consists solely of counting the number of <em>defects</em> (e.g. children with a specific disease) in the sample and checking whether a predetermined threshold value has been exceeded. This combination of data collection and data analysis is called a <em>sampling plan</em>. LQAS sampling plans are developed by specifying:</p>
<ul>
<li><p><strong>A TRIAGE SYSTEM</strong>: A classification system that defines <em>high</em>, <em>moderate</em>, and <em>low</em> categories of the prevalence of the phenomenon of interest.</p></li>
<li><p><strong>ACCEPTABLE PROBABILITIES OF ERROR</strong>: There are two probabilities of error. These are termed provider <em>probability of error</em> (PPE) and <em>consumer probability of error</em> (CPE):</p>
<ul>
<li><p><strong>Provider Probability of Error (PPE)</strong>: The risk that the survey will indicate that prevalence is <em>high</em> when it is, in fact, <em>low</em>. PPE is analogous to <em>type I</em> (<span class="math inline">\(\alpha\)</span>) error in statistical hypothesis testing.</p></li>
<li><p><strong>Consumer Probability of Error (CPE)</strong>: The risk that the survey will indicate that prevalence is <em>low</em> when it is, in fact, <em>high</em>. CPE is analogous to <em>type II</em> (<span class="math inline">\(\beta\)</span>) error in statistical hypothesis testing.</p></li>
</ul></li>
</ul>
<p>Once the upper and lower levels of the triage system and acceptable levels of error have been decided, a set of probability tables are constructed that are used to select a maximum sample size (<code>n</code>) and the number of defects or cases (<code>d</code>) that are allowed in the sample of <code>n</code> subjects before deciding that a population is a high prevalence population. The combination of maximum sample size (<code>n</code>) and number of defects (<code>d</code>) form the stopping rules of the sampling plan. Sampling stops when either the maximum sample size (<code>n</code>) is met or the allowable number of defects (<code>d</code>) is exceeded:</p>
<ul>
<li><p>If <code>d</code> is exceeded then the population is classified as high prevalence.</p></li>
<li><p>If <code>n</code> is met without d being exceeded then the population is classified as low prevalence.</p></li>
</ul>
<p>The values of <code>n</code> and <code>d</code> used in a sampling plan depend upon the threshold values used in the triage system and the acceptable levels of error. The values of <code>n</code> and <code>d</code> used in a sampling plan are calculated using binomial probabilities. For example, the probabilities of finding 14 or fewer cases (<span class="math inline">\(d = 14\)</span>) in a sample of 50 individuals (<span class="math inline">\(n = 50\)</span>) from populations with prevalences of either 20% or 40% are:</p>
<pre class="sourceCode r" id="cb734"><code class="sourceCode r"><a class="sourceLine" id="cb734-1" data-line-number="1"><span class="kw">pbinom</span>(<span class="dt">q =</span> <span class="dv">14</span>, <span class="dt">size =</span> <span class="dv">50</span>, <span class="dt">prob =</span> <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb734-2" data-line-number="2"><span class="kw">pbinom</span>(<span class="dt">q =</span> <span class="dv">14</span>, <span class="dt">size =</span> <span class="dv">50</span>, <span class="dt">prob =</span> <span class="fl">0.4</span>)</a></code></pre>
<pre><code>## [1] 0.9392779</code></pre>
<pre><code>## [1] 0.05395503</code></pre>
<p>The sampling plan with <span class="math inline">\(n = 50\)</span> and <span class="math inline">\(d = 14\)</span> is, therefore, a reasonable candidate for a sampling plan intended to distinguish between populations with prevalences of less than or equal to 20% and populations with prevalences greater than or equal to 40%.</p>
<p>There is no middle ground with LQAS sampling plans. Population are always classified as either high or low prevalence. Populations with prevalences between the upper and lower standards of the triage system are classified as high or low prevalence populations. The probability of a moderate prevalence population being classified as high or low prevalence is proportional to the proximity of the prevalence in that population to the triage standards. Moderate prevalence populations close to the upper standard will tend to be classified as high prevalence populations. Moderate prevalence populations close to the lower standard will tend to be classified as low prevalence populations. This behaviour is summarised by the operating characteristic (OC) curve for the sampling plan. For example:</p>
<pre class="sourceCode r" id="cb737"><code class="sourceCode r"><a class="sourceLine" id="cb737-1" data-line-number="1"><span class="kw">plot</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.6</span>, <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb737-2" data-line-number="2">     <span class="kw">pbinom</span>(<span class="dv">14</span>, <span class="dv">50</span>, <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.6</span>, <span class="fl">0.01</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb737-3" data-line-number="3">     <span class="dt">main =</span> <span class="st">&quot;OC Curve for n = 50, d = 14&quot;</span>,</a>
<a class="sourceLine" id="cb737-4" data-line-number="4">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion diseased&quot;</span>,</a>
<a class="sourceLine" id="cb737-5" data-line-number="5">     <span class="dt">ylab =</span> <span class="st">&quot;Probability&quot;</span>,</a>
<a class="sourceLine" id="cb737-6" data-line-number="6">     <span class="dt">type =</span> <span class="st">&quot;l&quot;</span>, <span class="dt">lty =</span> <span class="dv">2</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-497-1.png" width="672" /></p>
<p>The data we will use for the simulation is stored in forty-eight separate files. These files contain the returns from whole community screens for active trachoma (TF/TI) in children undertaken as part of trachoma control activities in five African countries. Each file has the file suffix .sim. The name of the file reflects the country in which the data were collected. The data files are:</p>
<table style="width:75%;">
<colgroup>
<col width="29%" />
<col width="16%" />
<col width="29%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"><strong>File name</strong></th>
<th align="right"><strong>Files</strong></th>
<th align="left"><strong>Origin</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>egyptXX.sim</strong></td>
<td align="right">10</td>
<td align="left">Egypt</td>
</tr>
<tr class="even">
<td align="left"><strong>gambiaXX.sim</strong></td>
<td align="right">10</td>
<td align="left">Gambia</td>
</tr>
<tr class="odd">
<td align="left"><strong>ghanaXX.sim</strong></td>
<td align="right">3</td>
<td align="left">Ghana</td>
</tr>
<tr class="even">
<td align="left"><strong>tanzaniaXX.sim</strong></td>
<td align="right">14</td>
<td align="left">Tanzania</td>
</tr>
<tr class="odd">
<td align="left"><strong>togoXX.sim</strong></td>
<td align="right">11</td>
<td align="left">Togo</td>
</tr>
</tbody>
</table>
<p>All of these data files have the same structure. The variables in the data files are:</p>
<table style="width:93%;">
<colgroup>
<col width="22%" />
<col width="70%" />
</colgroup>
<tbody>
<tr class="odd">
<td><strong>hh</strong></td>
<td>Household identifier</td>
</tr>
<tr class="even">
<td><strong>sex</strong></td>
<td>Sex of child (1=male, 2=female)</td>
</tr>
<tr class="odd">
<td><strong>age</strong></td>
<td>Age of child in years</td>
</tr>
<tr class="even">
<td><strong>tfti</strong></td>
<td>Child has active (TF/TI) trachoma (0=no, 1=yes)</td>
</tr>
</tbody>
</table>
<p>Each row in these files represents a single child. For example:</p>
<pre class="sourceCode r" id="cb738"><code class="sourceCode r"><a class="sourceLine" id="cb738-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;gambia09.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb738-2" data-line-number="2">x[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, ]</a></code></pre>
<pre><code>##         hh sex age tfti
## 1  4008001   1   6    1
## 2  4008001   1   3    1
## 3  4008002   1   8    1
## 4  4008002   1   6    0
## 5  4008003   1   8    0
## 6  4008003   1   1    0
## 7  4008004   1   7    0
## 8  4008004   1   4    0
## 9  4008004   1   2    0
## 10 4008004   1   2    0</code></pre>
<p>Any rapid survey method that is appropriate for general use in developing countries is restricted to sampling <code>households</code> rather than <code>individuals</code>. Sampling households in order to sample individuals violates a principal requirement for a sample to be representative of the population from which it is drawn (i.e. that individuals are selected <code>independently</code> of each other). This lack of statistical independence amongst sampled individuals may invalidate standard approaches to selecting sampling plans leading to increased probabilities of error. This is likely to be a particular problem if cases tend to be clustered within households. Trachoma is an infectious disease that confers no lasting immunity in the host. Cases are, therefore, very likely to be clustered within households. One solution to this problem would be to sample (i.e. at random) a single child from each of the sampled households. This is not appropriate for active trachoma as the examination procedure often causes distress to younger children. This may influence survey staff to select older children, who tend to have a lower risk of infection, for examination. Sampling is, therefore, constrained to sampling all children in selected households.</p>
<p>The purpose of the simulations presented here is to determine whether the LQAS method is robust to:</p>
<ol style="list-style-type: decimal">
<li>The loss of sampling independence introduced by sampling households at random and examining all children in selected households for active trachoma.</li>
</ol>
<p>And:</p>
<ol start="2" style="list-style-type: decimal">
<li>The slight increase in the maximum sample size (<code>n</code>) introduced by examining all children in selected households for active trachoma.</li>
</ol>
<p>Each row in the datasets we will be using represents an individual child. Since we will simulate sampling households rather than individual children we need to be able to convert the datasets from one row per child to one row per household. We will write a function to do this.</p>
<p>Create a new function called <code>ind2hh()</code>:</p>
<pre class="sourceCode r" id="cb740"><code class="sourceCode r"><a class="sourceLine" id="cb740-1" data-line-number="1">ind2hh &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>ind2hh()</code>. Use the <code>fix()</code> function to edit the <code>ind2hh()</code> function:</p>
<pre class="sourceCode r" id="cb741"><code class="sourceCode r"><a class="sourceLine" id="cb741-1" data-line-number="1"><span class="kw">fix</span>(ind2hh)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb742"><code class="sourceCode r"><a class="sourceLine" id="cb742-1" data-line-number="1"><span class="cf">function</span>(data) {</a>
<a class="sourceLine" id="cb742-2" data-line-number="2">  n.kids &lt;-<span class="st"> </span>n.cases &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb742-3" data-line-number="3">  id &lt;-<span class="st"> </span><span class="kw">unique</span>(data<span class="op">$</span>hh)</a>
<a class="sourceLine" id="cb742-4" data-line-number="4">  <span class="cf">for</span>(household <span class="cf">in</span> id) {</a>
<a class="sourceLine" id="cb742-5" data-line-number="5">    temp &lt;-<span class="st"> </span><span class="kw">subset</span>(data, data<span class="op">$</span>hh <span class="op">==</span><span class="st"> </span>household)</a>
<a class="sourceLine" id="cb742-6" data-line-number="6">    n.kids &lt;-<span class="st"> </span><span class="kw">c</span>(n.kids, <span class="kw">nrow</span>(temp))</a>
<a class="sourceLine" id="cb742-7" data-line-number="7">    n.cases &lt;-<span class="st"> </span><span class="kw">c</span>(n.cases, <span class="kw">sum</span>(temp<span class="op">$</span>tfti))</a>
<a class="sourceLine" id="cb742-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb742-9" data-line-number="9">  result &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(id, n.kids, n.cases))</a>
<a class="sourceLine" id="cb742-10" data-line-number="10">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb742-11" data-line-number="11">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>Now we have created the <code>ind2hh()</code> function we should test it for correct operation. We will create a simple test data.frame (<code>test.df</code>) for this purpose:</p>
<pre class="sourceCode r" id="cb743"><code class="sourceCode r"><a class="sourceLine" id="cb743-1" data-line-number="1">test.df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>),  <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span> ,<span class="dv">0</span>)))</a>
<a class="sourceLine" id="cb743-2" data-line-number="2"><span class="kw">names</span>(test.df) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;hh&quot;</span>, <span class="st">&quot;tfti&quot;</span>)</a>
<a class="sourceLine" id="cb743-3" data-line-number="3">test.df</a></code></pre>
<pre><code>##   hh tfti
## 1  1    1
## 2  1    1
## 3  2    1
## 4  2    0
## 5  2    0</code></pre>
<p>The expected operation of the <code>ind2hh()</code> function given <code>test.df</code> as input is:</p>
<table style="width:24%;">
<colgroup>
<col width="8%" />
<col width="15%" />
</colgroup>
<tbody>
<tr class="odd">
<td>hh</td>
<td>tfti</td>
</tr>
<tr class="even">
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0</td>
</tr>
<tr class="even">
<td>2</td>
<td>0</td>
</tr>
</tbody>
</table>
<p>becomes</p>
<table style="width:39%;">
<colgroup>
<col width="8%" />
<col width="15%" />
<col width="15%" />
</colgroup>
<tbody>
<tr class="odd">
<td>id</td>
<td>n.kids</td>
<td>n.case</td>
</tr>
<tr class="even">
<td>1</td>
<td>2</td>
<td>2</td>
</tr>
<tr class="odd">
<td>2</td>
<td>3</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>Confirm this behaviour:</p>
<pre class="sourceCode r" id="cb745"><code class="sourceCode r"><a class="sourceLine" id="cb745-1" data-line-number="1">test.df</a>
<a class="sourceLine" id="cb745-2" data-line-number="2"><span class="kw">ind2hh</span>(test.df)</a></code></pre>
<pre><code>##   hh tfti
## 1  1    1
## 2  1    1
## 3  2    1
## 4  2    0
## 5  2    0</code></pre>
<pre><code>##   id n.kids n.cases
## 1  1      2       2
## 2  2      3       1</code></pre>
<p>We can apply this function to the datasets as required. For example:</p>
<pre class="sourceCode r" id="cb748"><code class="sourceCode r"><a class="sourceLine" id="cb748-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;gambia09.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb748-2" data-line-number="2">x</a>
<a class="sourceLine" id="cb748-3" data-line-number="3">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb748-4" data-line-number="4">x.hh</a></code></pre>
<pre><code>##          hh sex age tfti
## 1   4008001   1   6    1
## 2   4008001   1   3    1
## 3   4008002   1   8    1
## 4   4008002   1   6    0
## 5   4008003   1   8    0
## 6   4008003   1   1    0
## 7   4008004   1   7    0
## 8   4008004   1   4    0
## 9   4008004   1   2    0
## 10  4008004   1   2    0
## 11  4008004   1   4    0
## 12  4008005   1   1    0
## 13  4008006   1   7    0
## 14  4008006   1   5    0
## 15  4008007   1   5    0
## 16  4008007   1   9    0
## 17  4008007   1   9    0
## 18  4008008   1   9    1
## 19  4008008   1   8    0
## 20  4008008   1   1    0
## 21  4008009   1   4    1
## 22  4008009   1   2    0
## 23  4008010   1   7    1
## 24  4008010   1   7    0
## 25  4008010   1   9    0
## 26  4008010   1   2    0
## 27  4008011   1   5    0
## 28  4008011   1   8    0
## 29  4008011   1   5    0
## 30  4008012   1   9    1
## 31  4008013   1   3    1
## 32  4008013   1   7    1
## 33  4008013   1   5    1
## 34  4008013   1   2    0
## 35  4008013   1   3    0
## 36  4008013   1   7    0
## 37  4008014   1   9    1
## 38  4008014   1   1    1
## 39  4008014   1   7    1
## 40  4008015   1   5    1
## 41  4008015   1   6    1
## 42  4008015   1   1    1
## 43  4008015   1   5    1
## 44  4008015   1   7    0
## 45  4008015   1   2    0
## 46  4008015   1   9    0
## 47  4008016   1   9    1
## 48  4008016   1   7    1
## 49  4008016   1   9    1
## 50  4008016   1   4    1
## 51  4008016   1   7    1
## 52  4008016   1   5    1
## 53  4008016   1   8    1
## 54  4008017   1   5    1
## 55  4008017   1   8    0
## 56  4008018   1   5    0
## 57  4008018   1   2    0
## 58  4008019   1   4    1
## 59  4008019   1   6    0
## 60  4008020   1   1    0
## 61  4008020   1   4    1
## 62  4008020   1   2    0
## 63  4008021   1   3    0
## 64  4008021   1   7    0
## 65  4008021   1   9    1
## 66  4008021   1   2    0
## 67  4008022   1   5    0
## 68  4008022   1   8    0
## 69  4008022   1   5    0
## 70  4008023   1   6    1
## 71  4008023   1   3    1
## 72  4008024   1   2    1
## 73  4008024   1   5    1
## 74  4008024   1   2    0
## 75  4008024   1   3    0
## 76  4008024   1   8    0
## 77  4008025   1   3    0
## 78  4008025   1   8    0
## 79  4008026   1   6    1
## 80  4008026   1   8    0
## 81  4008026   1   1    0
## 82  4008026   1   7    0
## 83  4008027   1   4    0
## 84  4008027   1   7    0
## 85  4008027   1   2    0
## 86  4008027   1   2    0
## 87  4008027   1   1    0
## 88  4008028   1   4    0
## 89  4008028   1   5    0
## 90  4008028   1   7    0
## 91  4008029   1   5    0
## 92  4008029   1   3    0
## 93  4008029   1   6    0
## 94  4108001   1   6    1
## 95  4108001   1   3    1
## 96  4108002   1   8    1
## 97  4108002   1   6    0
## 98  4108003   1   8    0
## 99  4108003   1   1    0
## 100 4108004   1   7    0
## 101 4108004   1   4    0
## 102 4108004   1   2    0
## 103 4108004   1   2    0
## 104 4108004   1   4    0
## 105 4108005   1   1    0
## 106 4108006   1   7    0
## 107 4108006   1   5    0
## 108 4108007   1   5    0
## 109 4108007   1   9    0
## 110 4108007   1   9    0
## 111 4108008   1   9    1
## 112 4108008   1   8    0
## 113 4108008   1   1    0
## 114 4108009   1   4    1
## 115 4108009   1   2    0
## 116 4108010   1   7    1
## 117 4108010   1   7    0
## 118 4108010   1   9    0
## 119 4108010   1   2    0
## 120 4108011   1   5    0
## 121 4108011   1   8    0
## 122 4108011   1   5    0
## 123 4108012   1   9    1
## 124 4108013   1   3    1
## 125 4108013   1   7    1
## 126 4108013   1   5    1
## 127 4108013   1   2    0
## 128 4108013   1   3    0
## 129 4108013   1   7    0
## 130 4108014   1   9    1
## 131 4108014   1   1    1
## 132 4108014   1   7    1
## 133 4108015   1   5    1
## 134 4108015   1   6    1
## 135 4108015   1   1    1
## 136 4108015   1   5    1
## 137 4108015   1   7    0
## 138 4108015   1   2    0
## 139 4108015   1   9    0
## 140 4108016   1   9    1
## 141 4108016   1   7    1
## 142 4108016   1   9    1
## 143 4108016   1   4    1
## 144 4108016   1   7    1
## 145 4108016   1   5    1
## 146 4108016   1   8    1
## 147 4108017   1   5    1
## 148 4108017   1   8    0
## 149 4108018   1   5    0
## 150 4108018   1   2    0
## 151 4108019   1   4    1
## 152 4108019   1   6    0
## 153 4108020   1   1    0
## 154 4108020   1   4    1
## 155 4108020   1   2    0
## 156 4108021   1   3    0
## 157 4108021   1   7    0
## 158 4108021   1   9    1
## 159 4108021   1   2    0
## 160 4108022   1   5    0
## 161 4108022   1   8    0
## 162 4108022   1   5    0
## 163 4108023   1   6    1
## 164 4108023   1   3    1
## 165 4108024   1   2    1
## 166 4108024   1   5    1
## 167 4108024   1   2    0
## 168 4108024   1   3    0
## 169 4108024   1   8    0
## 170 4108025   1   3    0
## 171 4108025   1   8    0
## 172 4108026   1   6    1
## 173 4108026   1   8    0
## 174 4108026   1   1    0
## 175 4108026   1   7    0
## 176 4108027   1   4    0
## 177 4108027   1   7    0
## 178 4108027   1   2    0
## 179 4108027   1   2    0
## 180 4108027   1   1    0
## 181 4108028   1   4    0
## 182 4108028   1   5    0
## 183 4108028   1   7    0
## 184 4108029   1   5    0
## 185 4108029   1   3    0
## 186 4108029   1   6    0
## 187 4208001   1   6    1
## 188 4208001   1   3    1
## 189 4208002   1   8    1
## 190 4208002   1   6    0
## 191 4208003   1   8    0
## 192 4208003   1   1    0
## 193 4208004   1   7    0
## 194 4208004   1   4    0
## 195 4008004   1   2    0
## 196 4208004   1   2    0
## 197 4208004   1   4    0
## 198 4208005   1   1    0
## 199 4208006   1   7    0
## 200 4208006   1   5    0
## 201 4208007   1   5    0
## 202 4208007   1   9    0
## 203 4208007   1   9    0
## 204 4208008   1   9    1
## 205 4208008   1   8    0
## 206 4208008   1   1    0
## 207 4208009   1   4    1
## 208 4208009   1   2    0
## 209 4208010   1   7    1
## 210 4208010   1   7    0
## 211 4208010   1   9    0
## 212 4208010   1   2    0
## 213 4208011   1   5    0
## 214 4208011   1   8    0
## 215 4208011   1   5    0
## 216 4208012   1   9    1
## 217 4208013   1   3    1
## 218 4208013   1   7    1
## 219 4208013   1   5    1
## 220 4208013   1   2    0
## 221 4208013   1   3    0
## 222 4208013   1   7    0
## 223 4208014   1   9    1
## 224 4208014   1   1    1
## 225 4208014   1   7    1
## 226 4208015   1   5    1
## 227 4208015   1   6    1
## 228 4208015   1   1    1
## 229 4208015   1   5    1
## 230 4208015   1   7    0
## 231 4208015   1   2    0
## 232 4208015   1   9    0
## 233 4208016   1   9    1
## 234 4208016   1   7    1
## 235 4208016   1   9    1
## 236 4208016   1   4    1
## 237 4208016   1   7    1
## 238 4208016   1   5    1
## 239 4208016   1   8    1
## 240 4208017   1   5    1
## 241 4208017   1   8    0
## 242 4208018   1   5    0
## 243 4208018   1   2    0
## 244 4208019   1   4    1
## 245 4208019   1   6    0
## 246 4208020   1   1    0
## 247 4208020   1   4    1
## 248 4208020   1   2    0
## 249 4208021   1   3    0
## 250 4208021   1   7    0
## 251 4208021   1   9    1
## 252 4208021   1   2    0
## 253 4208022   1   5    0
## 254 4208022   1   8    0
## 255 4208022   1   5    0
## 256 4208023   1   6    1
## 257 4208023   1   3    1
## 258 4208024   1   2    1
## 259 4208024   1   5    1
## 260 4208024   1   2    0
## 261 4208024   1   3    0
## 262 4208024   1   8    0
## 263 4208025   1   3    0
## 264 4208025   1   8    0
## 265 4208026   1   6    1
## 266 4208026   1   8    0
## 267 4208026   1   1    0
## 268 4208026   1   7    0
## 269 4208027   1   4    0
## 270 4208027   1   7    0
## 271 4208027   1   2    0
## 272 4208027   1   2    0
## 273 4208027   1   1    0
## 274 4208028   1   4    0
## 275 4208028   1   5    0
## 276 4208028   1   7    0
## 277 4208029   1   5    0
## 278 4208029   1   3    0
## 279 4208029   1   6    0</code></pre>
<pre><code>##         id n.kids n.cases
## 1  4008001      2       2
## 2  4008002      2       1
## 3  4008003      2       0
## 4  4008004      6       0
## 5  4008005      1       0
## 6  4008006      2       0
## 7  4008007      3       0
## 8  4008008      3       1
## 9  4008009      2       1
## 10 4008010      4       1
## 11 4008011      3       0
## 12 4008012      1       1
## 13 4008013      6       3
## 14 4008014      3       3
## 15 4008015      7       4
## 16 4008016      7       7
## 17 4008017      2       1
## 18 4008018      2       0
## 19 4008019      2       1
## 20 4008020      3       1
## 21 4008021      4       1
## 22 4008022      3       0
## 23 4008023      2       2
## 24 4008024      5       2
## 25 4008025      2       0
## 26 4008026      4       1
## 27 4008027      5       0
## 28 4008028      3       0
## 29 4008029      3       0
## 30 4108001      2       2
## 31 4108002      2       1
## 32 4108003      2       0
## 33 4108004      5       0
## 34 4108005      1       0
## 35 4108006      2       0
## 36 4108007      3       0
## 37 4108008      3       1
## 38 4108009      2       1
## 39 4108010      4       1
## 40 4108011      3       0
## 41 4108012      1       1
## 42 4108013      6       3
## 43 4108014      3       3
## 44 4108015      7       4
## 45 4108016      7       7
## 46 4108017      2       1
## 47 4108018      2       0
## 48 4108019      2       1
## 49 4108020      3       1
## 50 4108021      4       1
## 51 4108022      3       0
## 52 4108023      2       2
## 53 4108024      5       2
## 54 4108025      2       0
## 55 4108026      4       1
## 56 4108027      5       0
## 57 4108028      3       0
## 58 4108029      3       0
## 59 4208001      2       2
## 60 4208002      2       1
## 61 4208003      2       0
## 62 4208004      4       0
## 63 4208005      1       0
## 64 4208006      2       0
## 65 4208007      3       0
## 66 4208008      3       1
## 67 4208009      2       1
## 68 4208010      4       1
## 69 4208011      3       0
## 70 4208012      1       1
## 71 4208013      6       3
## 72 4208014      3       3
## 73 4208015      7       4
## 74 4208016      7       7
## 75 4208017      2       1
## 76 4208018      2       0
## 77 4208019      2       1
## 78 4208020      3       1
## 79 4208021      4       1
## 80 4208022      3       0
## 81 4208023      2       2
## 82 4208024      5       2
## 83 4208025      2       0
## 84 4208026      4       1
## 85 4208027      5       0
## 86 4208028      3       0
## 87 4208029      3       0</code></pre>
<p>We will now write a function that will simulate a single LQAS survey. Create a new function called <code>lqas.run()</code>:</p>
<pre class="sourceCode r" id="cb751"><code class="sourceCode r"><a class="sourceLine" id="cb751-1" data-line-number="1">lqas.run &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>lqas.run()</code>.</p>
<p>Use the <code>fix()</code> function to edit the <code>lqas.run()</code> function:</p>
<pre class="sourceCode r" id="cb752"><code class="sourceCode r"><a class="sourceLine" id="cb752-1" data-line-number="1"><span class="kw">fix</span>(lqas.run)</a></code></pre>
<p>Edit the function to read:</p>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We should try this function on a low, a moderate, and a high prevalence dataset. To select suitable test datasets we need to know the prevalence in each dataset:</p>
<pre class="sourceCode r" id="cb753"><code class="sourceCode r"><a class="sourceLine" id="cb753-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">dir</span>(<span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.sim$&quot;</span>)) {</a>
<a class="sourceLine" id="cb753-2" data-line-number="2">  data &lt;-<span class="st"> </span><span class="kw">read.table</span>(i, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb753-3" data-line-number="3">  <span class="kw">cat</span>(i, <span class="st">&quot;:&quot;</span>, <span class="kw">mean</span>(data<span class="op">$</span>tfti), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb753-4" data-line-number="4">}</a></code></pre>
<pre><code>## egypt01.sim : 0.5913978 
## egypt02.sim : 0.09243697 
## egypt03.sim : 0.343949 
## egypt04.sim : 0.2546584 
## egypt05.sim : 0.1354839 
## egypt06.sim : 0.6993464 
## egypt07.sim : 0.09815951 
## egypt08.sim : 0.5668449 
## egypt09.sim : 0.5251799 
## egypt10.sim : 0.4343434 
## gambia01.sim : 0.08510638 
## gambia02.sim : 0.2517483 
## gambia03.sim : 0.1730769 
## gambia04.sim : 0.1866667 
## gambia05.sim : 0.1264368 
## gambia06.sim : 0.5180952 
## gambia07.sim : 0.3876652 
## gambia08.sim : 0.310559 
## gambia09.sim : 0.3548387 
## gambia10.sim : 0.3358491 
## ghana01.sim : 0.0990099 
## ghana02.sim : 0.2162162 
## ghana03.sim : 0.2781955 
## tanzania01.sim : 0.4672897 
## tanzania02.sim : 0.4563107 
## tanzania03.sim : 0.1025641 
## tanzania04.sim : 0.1724138 
## tanzania05.sim : 0.6962963 
## tanzania06.sim : 0.3092784 
## tanzania07.sim : 0.3727273 
## tanzania08.sim : 0.4454545 
## tanzania09.sim : 0.2146893 
## tanzania10.sim : 0.5925926 
## tanzania11.sim : 0.2544379 
## tanzania12.sim : 0.5619835 
## tanzania13.sim : 0.5086207 
## tanzania14.sim : 0.4105263 
## togo01.sim : 0.254902 
## togo02.sim : 0.1692308 
## togo03.sim : 0.2147651 
## togo04.sim : 0.1265823 
## togo05.sim : 0.1098266 
## togo06.sim : 0.2677165 
## togo07.sim : 0.3244681 
## togo08.sim : 0.3125 
## togo09.sim : 0.125 
## togo10.sim : 0.04385965 
## togo11.sim : 0.08609272</code></pre>
<p>The coding scheme used for the <code>tfti</code> variable (0=no, 1=yes) allows us to use the <code>mean()</code> function to calculate prevalence in these datasets.</p>
<p>The pattern <code>&quot;\\.sim$&quot;</code> is a regular expression for files ending in .sim.</p>
<p>If you want to use the <code>dir()</code> function to list files stored outside of the current working directory you will need to specify an appropriate value for the <code>path</code> parameter. On some systems you may also need to set the value of the <code>full.names</code> parameter to <code>TRUE</code>. For example:</p>
<pre class="sourceCode r" id="cb755"><code class="sourceCode r"><a class="sourceLine" id="cb755-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">dir</span>(<span class="dt">path =</span> <span class="st">&quot;~/prfe&quot;</span>, <span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.sim$&quot;</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>)) {</a>
<a class="sourceLine" id="cb755-2" data-line-number="2">  data &lt;-<span class="st"> </span><span class="kw">read.table</span>(i, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb755-3" data-line-number="3">  <span class="kw">cat</span>(i, <span class="st">&quot;:&quot;</span>, <span class="kw">mean</span>(data<span class="op">$</span>tfti), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb755-4" data-line-number="4">}</a></code></pre>
<p>cycles through all files ending in <code>.sim</code> (specified by giving the value <code>&quot;\\.sim$&quot;</code> to the <code>pattern</code> parameter) that are stored the <code>prfe</code> directory under the users home directory (specified by giving the value <code>&quot;~/prfe&quot;</code> to the <code>path</code> parameter) on UNIX systems. You <strong>cannot</strong> usefully specify a URL for the <code>path</code> parameter of the <code>dir()</code> function.</p>
<p>We will use <code>tanzania04.sim</code> as an example of a low prevalence dataset:</p>
<pre class="sourceCode r" id="cb756"><code class="sourceCode r"><a class="sourceLine" id="cb756-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;tanzania04.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb756-2" data-line-number="2">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb756-3" data-line-number="3"><span class="kw">lqas.run</span>(<span class="dt">x =</span> x.hh, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>)</a></code></pre>
<pre><code>## $kids
## [1] 52
## 
## $cases
## [1] 15
## 
## $outcome
## [1] 1</code></pre>
<p>Repeat the last function call several times. Remember that previous commands can be recalled and edited using the up and down arrow keys – they do not need to be typed out in full each time.</p>
<p>The function should, for most calls, return:</p>
<pre><code>$outcome
[1] 0</code></pre>
<p>We will use <code>tanzania08.sim</code> as an example of a high prevalence dataset:</p>
<pre class="sourceCode r" id="cb759"><code class="sourceCode r"><a class="sourceLine" id="cb759-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;tanzania08.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb759-2" data-line-number="2">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb759-3" data-line-number="3"><span class="kw">lqas.run</span>(<span class="dt">x =</span> x.hh, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>)</a></code></pre>
<pre><code>## $kids
## [1] 33
## 
## $cases
## [1] 16
## 
## $outcome
## [1] 1</code></pre>
<p>Repeat the last function call several times. The function should, for most calls, return:</p>
<pre><code>$outcome
[1] 1</code></pre>
<p>We will use <code>tanzania06.sim</code> as an example of a moderate prevalence dataset:</p>
<pre class="sourceCode r" id="cb762"><code class="sourceCode r"><a class="sourceLine" id="cb762-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;tanzania06.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb762-2" data-line-number="2">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb762-3" data-line-number="3"><span class="kw">lqas.run</span>(<span class="dt">x =</span> x.hh, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>)</a></code></pre>
<pre><code>## $kids
## [1] 40
## 
## $cases
## [1] 15
## 
## $outcome
## [1] 1</code></pre>
<p>Repeat the last function call several times. The function should return:</p>
<pre><code>$outcome
[1] 0</code></pre>
<p>And:</p>
<pre><code>$outcome
[1] 1</code></pre>
<p>In roughly equal proportion.</p>
<p>The simulation will require repeated sampling from the same dataset. We need to write a function to do this.</p>
<p>Create a new function called <code>lqas.simul()</code>:</p>
<pre class="sourceCode r" id="cb766"><code class="sourceCode r"><a class="sourceLine" id="cb766-1" data-line-number="1">lqas.simul &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>lqas.simul()</code>.</p>
<p>Use the <code>fix()</code> function to edit the <code>lqas.simul()</code> function:</p>
<pre class="sourceCode r" id="cb767"><code class="sourceCode r"><a class="sourceLine" id="cb767-1" data-line-number="1"><span class="kw">fix</span>(lqas.simul)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb768"><code class="sourceCode r"><a class="sourceLine" id="cb768-1" data-line-number="1"><span class="cf">function</span>(x, n, d, runs) {</a>
<a class="sourceLine" id="cb768-2" data-line-number="2">  all &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</a>
<a class="sourceLine" id="cb768-3" data-line-number="3">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>runs) {</a>
<a class="sourceLine" id="cb768-4" data-line-number="4">    run &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">lqas.run</span>(x, n ,d))</a>
<a class="sourceLine" id="cb768-5" data-line-number="5">    all &lt;-<span class="st"> </span><span class="kw">rbind</span>(all, run)</a>
<a class="sourceLine" id="cb768-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb768-7" data-line-number="7">  p &lt;-<span class="st"> </span><span class="kw">sum</span>(x<span class="op">$</span>n.cases) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(x<span class="op">$</span>n.kids)</a>
<a class="sourceLine" id="cb768-8" data-line-number="8">  asn &lt;-<span class="st"> </span><span class="kw">mean</span>(all<span class="op">$</span>kids)</a>
<a class="sourceLine" id="cb768-9" data-line-number="9">  p.high &lt;-<span class="st"> </span><span class="kw">mean</span>(all<span class="op">$</span>outcome)</a>
<a class="sourceLine" id="cb768-10" data-line-number="10">  result &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">p =</span> p, <span class="dt">asn =</span> asn, <span class="dt">p.high =</span> p.high)</a>
<a class="sourceLine" id="cb768-11" data-line-number="11">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb768-12" data-line-number="12">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We can test this function with the same three test datasets:</p>
<pre class="sourceCode r" id="cb769"><code class="sourceCode r"><a class="sourceLine" id="cb769-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;tanzania04.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb769-2" data-line-number="2">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb769-3" data-line-number="3"><span class="kw">lqas.simul</span>(<span class="dt">x =</span> x.hh, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>, <span class="dt">runs =</span> <span class="dv">250</span>)</a>
<a class="sourceLine" id="cb769-4" data-line-number="4"></a>
<a class="sourceLine" id="cb769-5" data-line-number="5">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;tanzania08.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb769-6" data-line-number="6">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb769-7" data-line-number="7"><span class="kw">lqas.simul</span>(<span class="dt">x =</span> x.hh, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>, <span class="dt">runs =</span> <span class="dv">250</span>)</a>
<a class="sourceLine" id="cb769-8" data-line-number="8"></a>
<a class="sourceLine" id="cb769-9" data-line-number="9">x &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="st">&quot;tanzania06.sim&quot;</span>, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb769-10" data-line-number="10">x.hh &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb769-11" data-line-number="11"><span class="kw">lqas.simul</span>( <span class="dt">x =</span> x.hh, <span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>, <span class="dt">runs =</span> <span class="dv">250</span>)</a></code></pre>
<pre><code>## $p
## [1] 0.1724138
## 
## $asn
## [1] 50.716
## 
## $p.high
## [1] 0.024</code></pre>
<pre><code>## $p
## [1] 0.4454545
## 
## $asn
## [1] 34.472
## 
## $p.high
## [1] 0.976</code></pre>
<pre><code>## $p
## [1] 0.3092784
## 
## $asn
## [1] 45.096
## 
## $p.high
## [1] 0.628</code></pre>
<p>The simulation consists of applying this function to each of the datasets in turn and collating the results. We will create a function to do this.</p>
<p>Create a new function called <code>main.simul()</code>:</p>
<pre class="sourceCode r" id="cb773"><code class="sourceCode r"><a class="sourceLine" id="cb773-1" data-line-number="1">main.simul &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>main.simul()</code>.</p>
<p>Use the <code>fix()</code> function to edit the <code>main.simul()</code> function:</p>
<pre class="sourceCode r" id="cb774"><code class="sourceCode r"><a class="sourceLine" id="cb774-1" data-line-number="1"><span class="kw">fix</span>(main.simul)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb775"><code class="sourceCode r"><a class="sourceLine" id="cb775-1" data-line-number="1"><span class="cf">function</span>(n, d, runs) {</a>
<a class="sourceLine" id="cb775-2" data-line-number="2">  result &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</a>
<a class="sourceLine" id="cb775-3" data-line-number="3">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">dir</span>(<span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.sim$&quot;</span>)) {</a>
<a class="sourceLine" id="cb775-4" data-line-number="4">    <span class="kw">cat</span>(<span class="st">&quot;.&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb775-5" data-line-number="5">    x &lt;-<span class="st"> </span><span class="kw">read.table</span>(i, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb775-6" data-line-number="6">    y &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb775-7" data-line-number="7">    z &lt;-<span class="st"> </span><span class="kw">lqas.simul</span>(y, n, d, runs)</a>
<a class="sourceLine" id="cb775-8" data-line-number="8">    z<span class="op">$</span>file.name &lt;-<span class="st"> </span>i</a>
<a class="sourceLine" id="cb775-9" data-line-number="9">    result &lt;-<span class="st"> </span><span class="kw">rbind</span>(result, <span class="kw">as.data.frame</span>(z))</a>
<a class="sourceLine" id="cb775-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb775-11" data-line-number="11">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb775-12" data-line-number="12">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We are now ready to run the simulation:</p>
<pre class="sourceCode r" id="cb776"><code class="sourceCode r"><a class="sourceLine" id="cb776-1" data-line-number="1">z1 &lt;-<span class="st"> </span><span class="kw">main.simul</span>(<span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>, <span class="dt">runs =</span> <span class="dv">250</span>)</a></code></pre>
<pre><code>## ................................................</code></pre>
<p>Progress of the simulation is shown by a lengthening line of dots. Each dot represents one community screening file processed. The <code>&gt;</code> prompt will be displayed when the simulation has finished running.</p>
<p>The returned data.frame object (<code>z1</code>) contains the results of the simulation:</p>
<pre class="sourceCode r" id="cb778"><code class="sourceCode r"><a class="sourceLine" id="cb778-1" data-line-number="1">z1</a></code></pre>
<pre><code>##             p    asn p.high      file.name
## 1  0.59139785 26.480  1.000    egypt01.sim
## 2  0.09243697 50.780  0.000    egypt02.sim
## 3  0.34394904 42.596  0.812    egypt03.sim
## 4  0.25465839 49.220  0.336    egypt04.sim
## 5  0.13548387 50.536  0.004    egypt05.sim
## 6  0.69934641 22.300  1.000    egypt06.sim
## 7  0.09815951 50.740  0.000    egypt07.sim
## 8  0.56684492 27.296  1.000    egypt08.sim
## 9  0.52517986 29.940  1.000    egypt09.sim
## 10 0.43434343 34.876  0.984    egypt10.sim
## 11 0.08510638 51.532  0.000   gambia01.sim
## 12 0.25174825 49.272  0.364   gambia02.sim
## 13 0.17307692 51.968  0.036   gambia03.sim
## 14 0.18666667 51.556  0.096   gambia04.sim
## 15 0.12643678 52.176  0.040   gambia05.sim
## 16 0.51809524 31.976  1.000   gambia06.sim
## 17 0.38766520 40.736  0.896   gambia07.sim
## 18 0.31055901 46.524  0.644   gambia08.sim
## 19 0.35483871 42.016  0.740   gambia09.sim
## 20 0.33584906 43.200  0.712   gambia10.sim
## 21 0.09900990 52.136  0.000    ghana01.sim
## 22 0.21621622 51.456  0.184    ghana02.sim
## 23 0.27819549 48.824  0.488    ghana03.sim
## 24 0.46728972 33.388  0.984 tanzania01.sim
## 25 0.45631068 33.928  0.996 tanzania02.sim
## 26 0.10256410 50.724  0.000 tanzania03.sim
## 27 0.17241379 50.564  0.032 tanzania04.sim
## 28 0.69629630 22.356  1.000 tanzania05.sim
## 29 0.30927835 45.188  0.600 tanzania06.sim
## 30 0.37272727 40.400  0.848 tanzania07.sim
## 31 0.44545455 34.600  0.996 tanzania08.sim
## 32 0.21468927 50.136  0.148 tanzania09.sim
## 33 0.59259259 25.324  1.000 tanzania10.sim
## 34 0.25443787 48.804  0.296 tanzania11.sim
## 35 0.56198347 29.640  1.000 tanzania12.sim
## 36 0.50862069 31.460  0.996 tanzania13.sim
## 37 0.41052632 37.300  0.972 tanzania14.sim
## 38 0.25490196 49.328  0.368     togo01.sim
## 39 0.16923077 55.384  0.048     togo02.sim
## 40 0.21476510 50.700  0.232     togo03.sim
## 41 0.12658228 52.152  0.012     togo04.sim
## 42 0.10982659 52.548  0.004     togo05.sim
## 43 0.26771654 47.136  0.452     togo06.sim
## 44 0.32446809 45.088  0.688     togo07.sim
## 45 0.31250000 44.744  0.672     togo08.sim
## 46 0.12500000 51.556  0.000     togo09.sim
## 47 0.04385965 51.936  0.000     togo10.sim
## 48 0.08609272 52.448  0.000     togo11.sim</code></pre>
<p>We can examine the prevalences in the test datasets:</p>
<pre class="sourceCode r" id="cb780"><code class="sourceCode r"><a class="sourceLine" id="cb780-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb780-2" data-line-number="2"></a>
<a class="sourceLine" id="cb780-3" data-line-number="3"><span class="kw">hist</span>(z1<span class="op">$</span>p,</a>
<a class="sourceLine" id="cb780-4" data-line-number="4">     <span class="dt">main =</span> <span class="st">&quot;Prevalence in test datasets&quot;</span>,</a>
<a class="sourceLine" id="cb780-5" data-line-number="5">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-529-1.png" width="672" /></p>
<p>If you are using a Macintosh computer then you can use <code>quartz()</code> instead of <code>x11()</code>. This will give better results.</p>
<p>We examine the sample size required to make classifications at different levels of prevalence as <em>anaverage sample number</em> (ASN) curve:</p>
<pre class="sourceCode r" id="cb781"><code class="sourceCode r"><a class="sourceLine" id="cb781-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb781-2" data-line-number="2"></a>
<a class="sourceLine" id="cb781-3" data-line-number="3"><span class="kw">plot</span>(z1<span class="op">$</span>p,</a>
<a class="sourceLine" id="cb781-4" data-line-number="4">     z1<span class="op">$</span>asn,</a>
<a class="sourceLine" id="cb781-5" data-line-number="5">     <span class="dt">main =</span> <span class="st">&quot;ASN Curve&quot;</span>,</a>
<a class="sourceLine" id="cb781-6" data-line-number="6">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>,</a>
<a class="sourceLine" id="cb781-7" data-line-number="7">     <span class="dt">ylab =</span> <span class="st">&quot;Sample size required&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-531-1.png" width="672" /></p>
<p>We can examine the performance of the sampling plan by plotting its <em>operating characteristic</em> (OC) curve:</p>
<pre class="sourceCode r" id="cb782"><code class="sourceCode r"><a class="sourceLine" id="cb782-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb782-2" data-line-number="2"></a>
<a class="sourceLine" id="cb782-3" data-line-number="3"><span class="kw">plot</span>(z1<span class="op">$</span>p,</a>
<a class="sourceLine" id="cb782-4" data-line-number="4">     z1<span class="op">$</span>p.high,</a>
<a class="sourceLine" id="cb782-5" data-line-number="5">     <span class="dt">main =</span> <span class="st">&quot;OC Curve&quot;</span>,</a>
<a class="sourceLine" id="cb782-6" data-line-number="6">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>,</a>
<a class="sourceLine" id="cb782-7" data-line-number="7">     <span class="dt">ylab =</span> <span class="st">&quot;Probability&quot;</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-533-1.png" width="672" /></p>
<p>Before closing the OC curve plot, we can compare the simulation results with the expected <em>operating characteristic</em> (OC) curve under ideal sampling conditions:</p>
<pre class="sourceCode r" id="cb783"><code class="sourceCode r"><a class="sourceLine" id="cb783-1" data-line-number="1"><span class="kw">lines</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">max</span>(z1<span class="op">$</span>p), <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb783-2" data-line-number="2">      <span class="kw">pbinom</span>(<span class="dv">14</span>, <span class="dv">50</span>,<span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">max</span>(z1<span class="op">$</span>p),<span class="fl">0.01</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb783-3" data-line-number="3">      <span class="dt">lty =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-535-1.png" width="672" /></p>
<p>The LQAS method appears to be robust to the loss of sampling variation introduced by the proposed sampling constraints. There is, however, some deviation from the expected <em>operating characteristic</em> (OC) curve at lower prevalences:</p>
<pre class="sourceCode r" id="cb784"><code class="sourceCode r"><a class="sourceLine" id="cb784-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb784-2" data-line-number="2"><span class="kw">plot</span>(z1<span class="op">$</span>p, z1<span class="op">$</span>p.high,</a>
<a class="sourceLine" id="cb784-3" data-line-number="3">     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="fl">0.10</span>, <span class="fl">0.35</span>),</a>
<a class="sourceLine" id="cb784-4" data-line-number="4">     <span class="dt">main =</span> <span class="st">&quot;OC Curve&quot;</span>,</a>
<a class="sourceLine" id="cb784-5" data-line-number="5">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>,</a>
<a class="sourceLine" id="cb784-6" data-line-number="6">     <span class="dt">ylab =</span> <span class="st">&quot;Probability&quot;</span>)</a>
<a class="sourceLine" id="cb784-7" data-line-number="7"></a>
<a class="sourceLine" id="cb784-8" data-line-number="8"><span class="kw">lines</span>(<span class="kw">seq</span>(<span class="fl">0.10</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb784-9" data-line-number="9">      <span class="kw">pbinom</span>(<span class="dv">14</span>, <span class="dv">50</span>, <span class="kw">seq</span>(<span class="fl">0.10</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb784-10" data-line-number="10">      <span class="dt">lty =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-537-1.png" width="672" /></p>
<p>This deviation from the expected <em>operating characteristic</em> (OC) curve is likely to be due to a few very large households in which many of the children have active trachoma. You can check this by examining the <code>p.high</code> (i.e. the probability of a classification as high prevalence) column in <code>z1</code>, and household size and trachoma status in the individual data files that return higher than expected values for <code>p.high</code>. The <code>ind2hh()</code> function is likely to prove useful in this context.</p>
<p>The observed deviation from the expected <em>operating characteristic</em> (OC) curve is small but it is important, in the resource-constrained context of trachoma-endemic countries, to minimise the false positive rate in order to ensure that resources are devoted to communities that need them most.</p>
<p>We might be able to improve the performance of the survey method in this regard by restricting the sample so that only younger children are examined. This will have the effect of reducing the number of children examined in each household. It also has the benefit of making the surveys simpler and quicker since younger children will tend to be closer to home than older children.</p>
<p>The range of ages in the datasets can be found using:</p>
<pre class="sourceCode r" id="cb785"><code class="sourceCode r"><a class="sourceLine" id="cb785-1" data-line-number="1"><span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">dir</span>(<span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.sim$&quot;</span>)) {</a>
<a class="sourceLine" id="cb785-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="kw">read.table</span>(i, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb785-3" data-line-number="3">  <span class="kw">cat</span>(i, <span class="st">&quot;:&quot;</span>, <span class="kw">range</span>(x<span class="op">$</span>age), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb785-4" data-line-number="4">}</a></code></pre>
<pre><code>## egypt01.sim : 1 10 
## egypt02.sim : 2 8 
## egypt03.sim : 2 10 
## egypt04.sim : 1 10 
## egypt05.sim : 2 6 
## egypt06.sim : 2 10 
## egypt07.sim : 2 6 
## egypt08.sim : 2 10 
## egypt09.sim : 2 10 
## egypt10.sim : 2 10 
## gambia01.sim : 1 9 
## gambia02.sim : 1 9 
## gambia03.sim : 1 9 
## gambia04.sim : 1 9 
## gambia05.sim : 1 9 
## gambia06.sim : 1 9 
## gambia07.sim : 1 9 
## gambia08.sim : 1 9 
## gambia09.sim : 1 9 
## gambia10.sim : 1 9 
## ghana01.sim : 1 10 
## ghana02.sim : 1 10 
## ghana03.sim : 1 10 
## tanzania01.sim : 1 10 
## tanzania02.sim : 1 10 
## tanzania03.sim : 1 10 
## tanzania04.sim : 1 10 
## tanzania05.sim : 1 10 
## tanzania06.sim : 1 10 
## tanzania07.sim : 1 10 
## tanzania08.sim : 1 10 
## tanzania09.sim : 1 10 
## tanzania10.sim : 1 10 
## tanzania11.sim : 1 10 
## tanzania12.sim : 1 10 
## tanzania13.sim : 1 10 
## tanzania14.sim : 1 10 
## togo01.sim : 1 10 
## togo02.sim : 1 10 
## togo03.sim : 1 10 
## togo04.sim : 1 10 
## togo05.sim : 1 10 
## togo06.sim : 1 10 
## togo07.sim : 1 10 
## togo08.sim : 1 10 
## togo09.sim : 1 10 
## togo10.sim : 1 10 
## togo11.sim : 1 10</code></pre>
<p>We will investigate the effect of restricting the sample to children aged between two and five years. Use the fix() function to edit the <code>main.simul()</code> function:</p>
<pre class="sourceCode r" id="cb787"><code class="sourceCode r"><a class="sourceLine" id="cb787-1" data-line-number="1"><span class="kw">fix</span>(main.simul)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb788"><code class="sourceCode r"><a class="sourceLine" id="cb788-1" data-line-number="1"><span class="cf">function</span>(n, d, runs) {</a>
<a class="sourceLine" id="cb788-2" data-line-number="2">  result &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</a>
<a class="sourceLine" id="cb788-3" data-line-number="3">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">dir</span>(<span class="dt">pattern =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">.sim$&quot;</span>)) {</a>
<a class="sourceLine" id="cb788-4" data-line-number="4">    <span class="kw">cat</span>(<span class="st">&quot;.&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb788-5" data-line-number="5">    x &lt;-<span class="st"> </span><span class="kw">read.table</span>(i, <span class="dt">header =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb788-6" data-line-number="6">    x &lt;-<span class="st"> </span><span class="kw">subset</span>(x, age <span class="op">&gt;=</span><span class="st"> </span><span class="dv">2</span> <span class="op">&amp;</span><span class="st"> </span>age <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb788-7" data-line-number="7">    y &lt;-<span class="st"> </span><span class="kw">ind2hh</span>(x)</a>
<a class="sourceLine" id="cb788-8" data-line-number="8">    z &lt;-<span class="st"> </span><span class="kw">lqas.simul</span>(y, n, d, runs) z<span class="op">$</span>file.name &lt;-<span class="st"> </span>i</a>
<a class="sourceLine" id="cb788-9" data-line-number="9">    result &lt;-<span class="st"> </span><span class="kw">rbind</span>(result, <span class="kw">as.data.frame</span>(z))</a>
<a class="sourceLine" id="cb788-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb788-11" data-line-number="11">  <span class="kw">return</span>(result)</a>
<a class="sourceLine" id="cb788-12" data-line-number="12">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We are now ready to run the simulation again:</p>
<pre class="sourceCode r" id="cb789"><code class="sourceCode r"><a class="sourceLine" id="cb789-1" data-line-number="1">z2 &lt;-<span class="st"> </span><span class="kw">main.simul</span>(<span class="dt">n =</span> <span class="dv">50</span>, <span class="dt">d =</span> <span class="dv">14</span>, <span class="dt">runs =</span> <span class="dv">250</span>)</a></code></pre>
<pre><code>## ................................................</code></pre>
<p>The data.frame object <code>z2</code> contains the results of the simulation:</p>
<pre class="sourceCode r" id="cb791"><code class="sourceCode r"><a class="sourceLine" id="cb791-1" data-line-number="1">z2</a></code></pre>
<pre><code>##             p    asn p.high      file.name
## 1  0.59139785 26.124  1.000    egypt01.sim
## 2  0.09243697 50.652  0.000    egypt02.sim
## 3  0.34394904 43.468  0.776    egypt03.sim
## 4  0.25465839 49.160  0.312    egypt04.sim
## 5  0.13548387 50.708  0.004    egypt05.sim
## 6  0.69934641 22.836  1.000    egypt06.sim
## 7  0.09815951 50.796  0.000    egypt07.sim
## 8  0.56684492 27.640  1.000    egypt08.sim
## 9  0.52517986 29.080  0.996    egypt09.sim
## 10 0.43434343 35.664  0.996    egypt10.sim
## 11 0.08510638 51.796  0.000   gambia01.sim
## 12 0.25174825 48.748  0.396   gambia02.sim
## 13 0.17307692 51.992  0.048   gambia03.sim
## 14 0.18666667 51.524  0.108   gambia04.sim
## 15 0.12643678 52.180  0.016   gambia05.sim
## 16 0.51809524 32.544  1.000   gambia06.sim
## 17 0.38766520 41.792  0.912   gambia07.sim
## 18 0.31055901 46.516  0.624   gambia08.sim
## 19 0.35483871 42.528  0.744   gambia09.sim
## 20 0.33584906 43.828  0.644   gambia10.sim
## 21 0.09900990 52.340  0.000    ghana01.sim
## 22 0.21621622 51.636  0.208    ghana02.sim
## 23 0.27819549 48.944  0.500    ghana03.sim
## 24 0.46728972 33.428  0.984 tanzania01.sim
## 25 0.45631068 33.212  1.000 tanzania02.sim
## 26 0.10256410 50.784  0.000 tanzania03.sim
## 27 0.17241379 50.560  0.024 tanzania04.sim
## 28 0.69629630 22.860  1.000 tanzania05.sim
## 29 0.30927835 45.152  0.652 tanzania06.sim
## 30 0.37272727 40.164  0.852 tanzania07.sim
## 31 0.44545455 34.244  0.976 tanzania08.sim
## 32 0.21468927 50.020  0.120 tanzania09.sim
## 33 0.59259259 26.140  1.000 tanzania10.sim
## 34 0.25443787 48.904  0.324 tanzania11.sim
## 35 0.56198347 29.620  1.000 tanzania12.sim
## 36 0.50862069 30.384  0.996 tanzania13.sim
## 37 0.41052632 37.288  0.976 tanzania14.sim
## 38 0.25490196 49.316  0.372     togo01.sim
## 39 0.16923077 55.564  0.072     togo02.sim
## 40 0.21476510 51.104  0.200     togo03.sim
## 41 0.12658228 52.036  0.012     togo04.sim
## 42 0.10982659 53.216  0.008     togo05.sim
## 43 0.26771654 48.676  0.392     togo06.sim
## 44 0.32446809 44.908  0.668     togo07.sim
## 45 0.31250000 45.436  0.632     togo08.sim
## 46 0.12500000 51.440  0.000     togo09.sim
## 47 0.04385965 52.464  0.000     togo10.sim
## 48 0.08609272 52.672  0.000     togo11.sim</code></pre>
<p>We can examine the performance of the sampling plan on the age-restricted datasets by plotting its <em>operating characteristic</em> (OC) curve and comparing the simulation results with the expected <em>operating characteristic</em> (OC) curve under ideal sampling conditions:</p>
<pre class="sourceCode r" id="cb793"><code class="sourceCode r"><a class="sourceLine" id="cb793-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb793-2" data-line-number="2"></a>
<a class="sourceLine" id="cb793-3" data-line-number="3"><span class="kw">plot</span>(z2<span class="op">$</span>p, z2<span class="op">$</span>p.high,</a>
<a class="sourceLine" id="cb793-4" data-line-number="4">     <span class="dt">main =</span> <span class="st">&quot;OC Curve&quot;</span>,</a>
<a class="sourceLine" id="cb793-5" data-line-number="5">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>,</a>
<a class="sourceLine" id="cb793-6" data-line-number="6">     <span class="dt">ylab =</span> <span class="st">&quot;Probability &quot;</span>)</a>
<a class="sourceLine" id="cb793-7" data-line-number="7"></a>
<a class="sourceLine" id="cb793-8" data-line-number="8"><span class="kw">lines</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">max</span>(z2<span class="op">$</span>p), <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb793-9" data-line-number="9">      <span class="kw">pbinom</span>(<span class="dv">14</span>, <span class="dv">50</span>, <span class="kw">seq</span>(<span class="dv">0</span>, <span class="kw">max</span>(z2<span class="op">$</span>p), <span class="fl">0.01</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb793-10" data-line-number="10">      <span class="dt">lty =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-544-1.png" width="672" /></p>
<p>Remember that if you are using a Macintosh computer then you can use <code>quartz()</code> instead of <code>x11()</code>. This will give better results.</p>
<p>We should also take a closer look at the range of prevalences where the deviation from the expected <em>operating characteristic</em> (OC) curve was largest and most problematic in the previous simulation:</p>
<pre class="sourceCode r" id="cb794"><code class="sourceCode r"><a class="sourceLine" id="cb794-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb794-2" data-line-number="2"></a>
<a class="sourceLine" id="cb794-3" data-line-number="3"><span class="kw">plot</span>(z2<span class="op">$</span>p, z2<span class="op">$</span>p.high,</a>
<a class="sourceLine" id="cb794-4" data-line-number="4">     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="fl">0.10</span>, <span class="fl">0.35</span>),</a>
<a class="sourceLine" id="cb794-5" data-line-number="5">     <span class="dt">main =</span> <span class="st">&quot;OC Curve&quot;</span>,</a>
<a class="sourceLine" id="cb794-6" data-line-number="6">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>,</a>
<a class="sourceLine" id="cb794-7" data-line-number="7">     <span class="dt">ylab =</span> <span class="st">&quot;Probability&quot;</span>)</a>
<a class="sourceLine" id="cb794-8" data-line-number="8"></a>
<a class="sourceLine" id="cb794-9" data-line-number="9"><span class="kw">lines</span>(<span class="kw">seq</span>(<span class="fl">0.10</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb794-10" data-line-number="10">      <span class="kw">pbinom</span>(<span class="dv">14</span>, <span class="dv">50</span>, <span class="kw">seq</span>(<span class="fl">0.10</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb794-11" data-line-number="11">      <span class="dt">lty =</span> <span class="dv">3</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-546-1.png" width="672" /></p>
<p>We can compare the behaviour of the sampling plan in the unrestricted and age-restricted datasets:</p>
<pre class="sourceCode r" id="cb795"><code class="sourceCode r"><a class="sourceLine" id="cb795-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb795-2" data-line-number="2"></a>
<a class="sourceLine" id="cb795-3" data-line-number="3"><span class="kw">plot</span>(z1<span class="op">$</span>p, z1<span class="op">$</span>p.high,</a>
<a class="sourceLine" id="cb795-4" data-line-number="4">     <span class="dt">main =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb795-5" data-line-number="5">     <span class="dt">xlab =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb795-6" data-line-number="6">     <span class="dt">ylab =</span> <span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb795-7" data-line-number="7">     <span class="dt">axes =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb795-8" data-line-number="8">     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>))</a>
<a class="sourceLine" id="cb795-9" data-line-number="9"></a>
<a class="sourceLine" id="cb795-10" data-line-number="10"><span class="kw">par</span>(<span class="dt">new =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb795-11" data-line-number="11"></a>
<a class="sourceLine" id="cb795-12" data-line-number="12"><span class="kw">plot</span>(z2<span class="op">$</span>p, z2<span class="op">$</span>p.high,</a>
<a class="sourceLine" id="cb795-13" data-line-number="13">     <span class="dt">main =</span> <span class="st">&quot;OC Curve&quot;</span>,</a>
<a class="sourceLine" id="cb795-14" data-line-number="14">     <span class="dt">xlab =</span> <span class="st">&quot;Proportion TF/TI&quot;</span>,</a>
<a class="sourceLine" id="cb795-15" data-line-number="15">     <span class="dt">ylab =</span> <span class="st">&quot;Probability&quot;</span>,</a>
<a class="sourceLine" id="cb795-16" data-line-number="16">     <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.8</span>),</a>
<a class="sourceLine" id="cb795-17" data-line-number="17">     <span class="dt">pch =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb795-18" data-line-number="18">   </a>
<a class="sourceLine" id="cb795-19" data-line-number="19"><span class="kw">lines</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="fl">0.01</span>),</a>
<a class="sourceLine" id="cb795-20" data-line-number="20">      <span class="kw">pbinom</span>(<span class="dv">14</span>, <span class="dv">50</span>, <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="fl">0.01</span>), <span class="dt">lower.tail =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb795-21" data-line-number="21">      <span class="dt">lty =</span> <span class="dv">3</span>)</a></code></pre>
<p>Restricting the sample to children aged between two and five years (inclusive) appears to have improved the behaviour of the survey method by lowering the false positive rate to close to expected behaviour under ideal sampling condition. Process simulation has allowed us to improve the performance of the survey method without expensive and lengthy field-work. In practice, the method would now be validated in the field probably by repeated sampling of communities in which prevalence is known from house-to-house screening.</p>
</div>
<div id="cellular-automata-machines" class="section level2">
<h2><span class="header-section-number">9.4</span> Cellular automata machines</h2>
<p><em>Cellular automata machines</em> are simple computing devices that are commonly used to simulate social, biological, and physical processes. Despite their simplicity, cellular automata machines are general purpose computing devices. This means that they may be used for any <em>computable</em> problem.</p>
<p>The way that problems are specified to cellular automata machines make them simple to program for some types of problem and difficult to program for other types of problem. In this exercise we will explore the use of cellular automata machines to create a simple model of epidemic spread.</p>
<p>Cellular automata machines model a universe in which space is represented by a uniform grid, time advances in steps, and the laws of the universe are represented by a set of rules which compute the future state of each cell of the grid from its current state and from the current state of its neighbouring cells.</p>
<p>Typically, a cellular automata machine has the following features:</p>
<ol style="list-style-type: decimal">
<li><p>It consists of a large number of identical cells arranged in a regular grid. The grid is a two-dimensional projection of a torus (a ring-doughnut shaped surface) and has no edges.</p></li>
<li><p>Each cell can be in one of a limited number of states.</p></li>
<li><p>Time advances through the simulation in steps. At each time-step, the state of a cell may change.</p></li>
<li><p>The state of a cell after each time-step is determined by a set of rules that define how the future state of a cell depends on the current state of the cell and the current state of its immediate neighbours. This set of rules is used to update the state of every cell in the grid at each time-step. Since the rules refer only to the state of an individual cell and its immediate neighbours, cellular automata machines are best suited to modelling situations where local interactions give rise to global phenomena.</p></li>
</ol>
<p>In this exercise we will simulate a cellular automata machine using <code>R</code> and then use the simulated machine to simulate epidemic spread. We will use three functions to simulate the cellular automata machine (CAM):</p>
<ul>
<li><p><strong>cam.run():</strong> This function will display the initial state of the CAM, examine each cell in the CAM grid, apply the CAM rule-set to each cell, update the CAM grid, and display the state of the CAM at each time-step.</p></li>
<li><p><strong>cam.state.display():</strong> This function will display the state of the CAM at each time-step. It will be implemented using the <code>image()</code> function to plot the contents of matrices held in the <code>cam.state</code> list object (see below). This function will be developed as we refine the epidemic model.</p></li>
<li><p><strong>cam.rule():</strong> This function will contain the rule-set. It will be implemented using <code>ifelse()</code> functions to codify rules. This function will also be developed as we refine the epidemic model.</p></li>
</ul>
<p>The current and future states of the CAM will be held in two <em>global</em> list objects:</p>
<ul>
<li><p><strong>cam.state:</strong> This object will contain the current state of the CAM and must contain a matrix object
called grid.</p></li>
<li><p><strong>cam.state.new:</strong> This object will contain the the state of the CAM at the next time-step as defined
by the the rule-set.</p></li>
</ul>
<p>Other <em>global</em> objects will be defined as required.</p>
<p>Create a new function called <code>cam.run():</code></p>
<pre class="sourceCode r" id="cb796"><code class="sourceCode r"><a class="sourceLine" id="cb796-1" data-line-number="1">cam.run &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>cam.run()</code>.</p>
<p>Use the <code>fix()</code> function to edit the <code>cam.run()</code> function:</p>
<pre class="sourceCode r" id="cb797"><code class="sourceCode r"><a class="sourceLine" id="cb797-1" data-line-number="1"><span class="kw">fix</span>(cam.run)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb798"><code class="sourceCode r"><a class="sourceLine" id="cb798-1" data-line-number="1"><span class="cf">function</span>(steps) {</a>
<a class="sourceLine" id="cb798-2" data-line-number="2">  cam.state.new &lt;&lt;-<span class="st"> </span>cam.state</a>
<a class="sourceLine" id="cb798-3" data-line-number="3">  <span class="kw">cam.state.display</span>(<span class="dt">t =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb798-4" data-line-number="4">  mx &lt;-<span class="st"> </span><span class="kw">nrow</span>(cam.state<span class="op">$</span>grid)</a>
<a class="sourceLine" id="cb798-5" data-line-number="5">  my &lt;-<span class="st"> </span><span class="kw">ncol</span>(cam.state<span class="op">$</span>grid)</a>
<a class="sourceLine" id="cb798-6" data-line-number="6">  <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>steps) {</a>
<a class="sourceLine" id="cb798-7" data-line-number="7">    <span class="cf">for</span>(y <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>my) {</a>
<a class="sourceLine" id="cb798-8" data-line-number="8">      <span class="cf">for</span>(x <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>mx) {</a>
<a class="sourceLine" id="cb798-9" data-line-number="9">        V &lt;-<span class="st"> </span>cam.state<span class="op">$</span>grid[x, y]</a>
<a class="sourceLine" id="cb798-10" data-line-number="10">        N &lt;-<span class="st"> </span>cam.state<span class="op">$</span>grid[x, <span class="kw">ifelse</span>(y <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, my, y <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb798-11" data-line-number="11">        S &lt;-<span class="st"> </span>cam.state<span class="op">$</span>grid[x, <span class="kw">ifelse</span>(y <span class="op">==</span><span class="st"> </span>my, <span class="dv">1</span>, y <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)]</a>
<a class="sourceLine" id="cb798-12" data-line-number="12">        E &lt;-<span class="st"> </span>cam.state<span class="op">$</span>grid[<span class="kw">ifelse</span>(x <span class="op">==</span><span class="st"> </span>mx, <span class="dv">1</span>, x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>), y]</a>
<a class="sourceLine" id="cb798-13" data-line-number="13">        W &lt;-<span class="st"> </span>cam.state<span class="op">$</span>grid[<span class="kw">ifelse</span>(x <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, mx, x <span class="op">-</span><span class="st"> </span><span class="dv">1</span>), y]</a>
<a class="sourceLine" id="cb798-14" data-line-number="14">        <span class="kw">cam.rule</span>(V, N, S, E, W, x, y, t)</a>
<a class="sourceLine" id="cb798-15" data-line-number="15">        }</a>
<a class="sourceLine" id="cb798-16" data-line-number="16">      }</a>
<a class="sourceLine" id="cb798-17" data-line-number="17">      cam.state &lt;&lt;-<span class="st"> </span>cam.state.new</a>
<a class="sourceLine" id="cb798-18" data-line-number="18">      <span class="kw">cam.state.display</span>(t)</a>
<a class="sourceLine" id="cb798-19" data-line-number="19">  }</a>
<a class="sourceLine" id="cb798-20" data-line-number="20">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the</p>
<p>Note that when we assign anything to the state of the CAM (held in <code>cam.state</code> and <code>cam.state.new</code>) we use the <code>&lt;&lt;-</code> (instead of the usual <code>&lt;-</code>) assignment operator. This operator allows assignment to objects outside of the function in the global environment.</p>
<p>Objects that are stored in the <em>global</em> environment are available to all functions.</p>
<p>Create a new function called <code>cam.state.display()</code>:</p>
<pre class="sourceCode r" id="cb799"><code class="sourceCode r"><a class="sourceLine" id="cb799-1" data-line-number="1">cam.state.display &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>cam.state.display()</code>.</p>
<p>Use the <code>fix()</code> function to edit the <code>cam.state.display()</code> function:</p>
<pre class="sourceCode r" id="cb800"><code class="sourceCode r"><a class="sourceLine" id="cb800-1" data-line-number="1"><span class="kw">fix</span>(cam.state.display)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb801"><code class="sourceCode r"><a class="sourceLine" id="cb801-1" data-line-number="1"><span class="cf">function</span>(t) {</a>
<a class="sourceLine" id="cb801-2" data-line-number="2">  <span class="cf">if</span>(t <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb801-3" data-line-number="3">    <span class="kw">x11</span>(); <span class="kw">par</span>(<span class="dt">pty =</span> <span class="st">&quot;s&quot;</span>)</a>
<a class="sourceLine" id="cb801-4" data-line-number="4">  }</a>
<a class="sourceLine" id="cb801-5" data-line-number="5">  <span class="kw">image</span>(cam.state<span class="op">$</span>grid, <span class="dt">main =</span> <span class="kw">paste</span>(<span class="st">&quot;Infected at :&quot;</span>, t),</a>
<a class="sourceLine" id="cb801-6" data-line-number="6">        <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;wheat&quot;</span>, <span class="st">&quot;navy&quot;</span>), <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb801-7" data-line-number="7">}</a></code></pre>
<p>Remember that if you are using a Macintosh computer then you can use <code>quartz()</code> instead of <code>x11()</code>. This will give better results.</p>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>The <code>cam.rule()</code> function contains the rules of the CAM universe.</p>
<p>We will start with a very simple <em>infection</em> rule:</p>
<ul>
<li><p>Each cell can be either <em>infected</em> or <em>not-infected</em>.</p></li>
<li><p>If a cell is already <em>infected</em> it will remain <em>infected</em>.</p></li>
<li><p>If a cell is <em>not-infected</em> then it will change its state to <em>infected</em> based on the state of its neighbours: If a neighbouring cell is <em>infected</em> it will infect the cell with a fixed probability or <em>transmission</em> pressure.</p></li>
</ul>
<p>Create a new function called <code>cam.rule()</code>:</p>
<pre class="sourceCode r" id="cb802"><code class="sourceCode r"><a class="sourceLine" id="cb802-1" data-line-number="1">cam.rule &lt;-<span class="st"> </span><span class="cf">function</span>() {}</a></code></pre>
<p>This creates an empty function called <code>cam.rule()</code>. Use the <code>fix()</code> function to edit the <code>cam.rule()</code> function:</p>
<pre class="sourceCode r" id="cb803"><code class="sourceCode r"><a class="sourceLine" id="cb803-1" data-line-number="1"><span class="kw">fix</span>(cam.rule)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb804"><code class="sourceCode r"><a class="sourceLine" id="cb804-1" data-line-number="1"><span class="cf">function</span>(V, N, S, E, W, x, y, t) {</a>
<a class="sourceLine" id="cb804-2" data-line-number="2">  tp &lt;-<span class="st"> </span><span class="kw">c</span>(N, S, E, W) <span class="op">*</span><span class="st"> </span><span class="kw">rbinom</span>(<span class="dv">4</span>, <span class="dv">1</span>, TP)</a>
<a class="sourceLine" id="cb804-3" data-line-number="3">  cam.state.new<span class="op">$</span>grid[x, y] &lt;&lt;-<span class="st"> </span><span class="kw">ifelse</span>(V <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span><span class="kw">sum</span>(tp) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb804-4" data-line-number="4">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor. The basic CAM machine is now complete.</p>
<p>We need to specify a value for the transmission pressure (<code>TP</code>):</p>
<pre class="sourceCode r" id="cb805"><code class="sourceCode r"><a class="sourceLine" id="cb805-1" data-line-number="1">TP &lt;-<span class="st"> </span><span class="fl">0.2</span></a></code></pre>
<p>And define the initial state of the CAM:</p>
<pre class="sourceCode r" id="cb806"><code class="sourceCode r"><a class="sourceLine" id="cb806-1" data-line-number="1">cases &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb806-2" data-line-number="2">cases[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb806-3" data-line-number="3">cam.state &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">grid =</span> cases)</a></code></pre>
<p>We can now run the simulation:</p>
<pre class="sourceCode r" id="cb807"><code class="sourceCode r"><a class="sourceLine" id="cb807-1" data-line-number="1"><span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">20</span>)</a></code></pre>
<p>The number of infected cells is:</p>
<pre class="sourceCode r" id="cb808"><code class="sourceCode r"><a class="sourceLine" id="cb808-1" data-line-number="1"><span class="kw">sum</span>(cam.state<span class="op">$</span>grid)</a></code></pre>
<pre><code>## [1] 1</code></pre>
<p>We can use this model to investigate the effect of different transmission pressures by systematically altering the transmission pressure specified in <code>TP</code>:</p>
<pre class="sourceCode r" id="cb810"><code class="sourceCode r"><a class="sourceLine" id="cb810-1" data-line-number="1">cases &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb810-2" data-line-number="2">cases[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb810-3" data-line-number="3">cam.state.initial &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">grid =</span> cases)</a>
<a class="sourceLine" id="cb810-4" data-line-number="4">pressure &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>)</a>
<a class="sourceLine" id="cb810-5" data-line-number="5">infected &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>)</a>
<a class="sourceLine" id="cb810-6" data-line-number="6">   </a>
<a class="sourceLine" id="cb810-7" data-line-number="7"><span class="cf">for</span>(TP <span class="cf">in</span> <span class="kw">seq</span>(<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.05</span>)) {</a>
<a class="sourceLine" id="cb810-8" data-line-number="8">  cam.state &lt;-<span class="st"> </span>cam.state.initial</a>
<a class="sourceLine" id="cb810-9" data-line-number="9">  <span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">20</span>)</a>
<a class="sourceLine" id="cb810-10" data-line-number="10">  <span class="kw">graphics.off</span>()</a>
<a class="sourceLine" id="cb810-11" data-line-number="11">  pressure &lt;-<span class="st"> </span><span class="kw">c</span>(pressure, TP)</a>
<a class="sourceLine" id="cb810-12" data-line-number="12">  infected &lt;-<span class="st"> </span><span class="kw">c</span>(infected, <span class="kw">sum</span>(cam.state<span class="op">$</span>grid))</a>
<a class="sourceLine" id="cb810-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb810-14" data-line-number="14"></a>
<a class="sourceLine" id="cb810-15" data-line-number="15"><span class="kw">plot</span>(pressure, infected)</a></code></pre>
<p>In practice we would run the simulation many times for each transmission pressure and plot (e.g.) the median number of infected cells found at the end of each run of the model.</p>
<p>We can extend the model to include host immunity by specifying a new layer of cells (i.e. for host immunity) and modifying the CAM rule-set appropriately.</p>
<p>Use the <code>fix()</code> function to edit the <code>cam.rule()</code> function:</p>
<pre class="sourceCode r" id="cb811"><code class="sourceCode r"><a class="sourceLine" id="cb811-1" data-line-number="1"><span class="kw">fix</span>(cam.rule)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb812"><code class="sourceCode r"><a class="sourceLine" id="cb812-1" data-line-number="1"><span class="cf">function</span>(V, N, S, E, W, x, y, t) {</a>
<a class="sourceLine" id="cb812-2" data-line-number="2">  tp &lt;-<span class="st"> </span><span class="kw">c</span>(N, S, E, W) <span class="op">*</span><span class="st"> </span><span class="kw">rbinom</span>(<span class="dv">4</span>, <span class="dv">1</span>, TP)</a>
<a class="sourceLine" id="cb812-3" data-line-number="3">  cam.state.new<span class="op">$</span>grid[x, y] &lt;&lt;-<span class="st"> </span><span class="kw">ifelse</span>(V <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>(<span class="kw">sum</span>(tp) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>cam.state<span class="op">$</span>immune[x, y] <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>), <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb812-4" data-line-number="4">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We need to specify values for the transmission pressure (<code>TP</code>) and the proportion of the population that is immune (<code>IM</code>):</p>
<pre class="sourceCode r" id="cb813"><code class="sourceCode r"><a class="sourceLine" id="cb813-1" data-line-number="1">TP &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb813-2" data-line-number="2">IM &lt;-<span class="st"> </span><span class="fl">0.4</span></a></code></pre>
<p>And define the initial state of the CAM:</p>
<pre class="sourceCode r" id="cb814"><code class="sourceCode r"><a class="sourceLine" id="cb814-1" data-line-number="1">cases &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb814-2" data-line-number="2">cases[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb814-3" data-line-number="3">immune &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbinom</span>(<span class="dv">361</span>, <span class="dv">1</span>, IM), <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb814-4" data-line-number="4">immune[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb814-5" data-line-number="5">cam.state &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">grid =</span> cases, <span class="dt">immune =</span> immune)</a></code></pre>
<p>We can display the distribution of immune cells using the <code>image()</code> function:</p>
<pre class="sourceCode r" id="cb815"><code class="sourceCode r"><a class="sourceLine" id="cb815-1" data-line-number="1"><span class="kw">image</span>(cam.state<span class="op">$</span>immune, <span class="dt">main =</span> <span class="st">&quot;Immune&quot;</span>,</a>
<a class="sourceLine" id="cb815-2" data-line-number="2">      <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;wheat&quot;</span>, <span class="st">&quot;navy&quot;</span>), <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-570-1.png" width="672" /></p>
<p>We can now run the simulation:</p>
<pre class="sourceCode r" id="cb816"><code class="sourceCode r"><a class="sourceLine" id="cb816-1" data-line-number="1"><span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">30</span>)</a></code></pre>
<p>The number of infected cells is:</p>
<pre class="sourceCode r" id="cb817"><code class="sourceCode r"><a class="sourceLine" id="cb817-1" data-line-number="1"><span class="kw">sum</span>(cam.state<span class="op">$</span>grid)</a></code></pre>
<pre><code>## [1] 1</code></pre>
<p>A better summary is the proportion of susceptible (i.e. non-immune) cells that become infected during a run:</p>
<pre class="sourceCode r" id="cb819"><code class="sourceCode r"><a class="sourceLine" id="cb819-1" data-line-number="1"><span class="kw">sum</span>(cam.state<span class="op">$</span>grid) <span class="op">/</span><span class="st"> </span>(<span class="dv">361</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(cam.state<span class="op">$</span>immune))</a></code></pre>
<pre><code>## [1] 0.004975124</code></pre>
<p>We can use this model to investigate the effect of different proportions of the population that are immune by systematically altering the value assigned to <code>IM</code>:</p>
<pre class="sourceCode r" id="cb821"><code class="sourceCode r"><a class="sourceLine" id="cb821-1" data-line-number="1">immune.p &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>)</a>
<a class="sourceLine" id="cb821-2" data-line-number="2">infected.p &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="dt">mode =</span> <span class="st">&quot;numeric&quot;</span>)</a>
<a class="sourceLine" id="cb821-3" data-line-number="3"></a>
<a class="sourceLine" id="cb821-4" data-line-number="4"><span class="cf">for</span>(IM <span class="cf">in</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.8</span>, <span class="fl">0.05</span>)) {</a>
<a class="sourceLine" id="cb821-5" data-line-number="5">  cases &lt;-<span class="st">  </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb821-6" data-line-number="6">  cases[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb821-7" data-line-number="7">  immune &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbinom</span>(<span class="dv">361</span>, <span class="dv">1</span>, IM), <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb821-8" data-line-number="8">  immune[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb821-9" data-line-number="9">  cam.state &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">grid =</span> cases, <span class="dt">immune =</span> immune)</a>
<a class="sourceLine" id="cb821-10" data-line-number="10">  <span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">30</span>)</a>
<a class="sourceLine" id="cb821-11" data-line-number="11">  <span class="kw">graphics.off</span>()</a>
<a class="sourceLine" id="cb821-12" data-line-number="12">  immune.p &lt;-<span class="st"> </span><span class="kw">c</span>(immune.p, <span class="kw">sum</span>(cam.state<span class="op">$</span>immune) <span class="op">/</span><span class="st"> </span><span class="dv">361</span>)</a>
<a class="sourceLine" id="cb821-13" data-line-number="13">  infected.p &lt;-<span class="st"> </span><span class="kw">c</span>(infected.p,</a>
<a class="sourceLine" id="cb821-14" data-line-number="14">                  <span class="kw">sum</span>(cam.state<span class="op">$</span>grid) <span class="op">/</span><span class="st"> </span>(<span class="dv">361</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(cam.state<span class="op">$</span>immune)))</a>
<a class="sourceLine" id="cb821-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb821-16" data-line-number="16"></a>
<a class="sourceLine" id="cb821-17" data-line-number="17"><span class="kw">plot</span>(immune.p, infected.p)</a></code></pre>
<p>In practice we would run the simulation many times for each value of <code>IM</code> and plot (e.g.) the median proportion of susceptible (i.e. non-immune) cells that become infected.</p>
<p>A simple modification to this model would be to record the time-step at which individual cells become infected.
We can do this by adding a new layer of cells (i.e. to record the time-step at which a cell becomes infected) and modifying the CAM rule-set appropriately.</p>
<p>Use the <code>fix()</code> function to edit the <code>cam.rule()</code> function:</p>
<pre class="sourceCode r" id="cb822"><code class="sourceCode r"><a class="sourceLine" id="cb822-1" data-line-number="1"><span class="kw">fix</span>(cam.rule)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb823"><code class="sourceCode r"><a class="sourceLine" id="cb823-1" data-line-number="1"><span class="cf">function</span>(V, N, S, E, W, x, y, t) {</a>
<a class="sourceLine" id="cb823-2" data-line-number="2">  tp &lt;-<span class="st"> </span><span class="kw">c</span>(N, S, E, W) <span class="op">*</span><span class="st"> </span><span class="kw">rbinom</span>(<span class="dv">4</span>, <span class="dv">1</span>, TP)</a>
<a class="sourceLine" id="cb823-3" data-line-number="3">  cam.state.new<span class="op">$</span>grid[x, y] &lt;&lt;-<span class="st"> </span><span class="kw">ifelse</span>(V <span class="op">==</span><span class="st"> </span><span class="dv">1</span> <span class="op">|</span><span class="st"> </span>(<span class="kw">sum</span>(tp) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>cam.state<span class="op">$</span>immune[x, y] <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>), <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb823-4" data-line-number="4">  <span class="cf">if</span>(V <span class="op">!=</span><span class="st"> </span><span class="dv">1</span> <span class="op">&amp;</span><span class="st"> </span>cam.state.new<span class="op">$</span>grid[x, y] <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb823-5" data-line-number="5">    cam.state.new<span class="op">$</span>ti[x, y] &lt;&lt;-<span class="st"> </span>t</a>
<a class="sourceLine" id="cb823-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb823-7" data-line-number="7">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We need to specify values for the transmission pressure (<code>TP</code>) and the proportion of the population that is immune (<code>IM</code>):</p>
<pre class="sourceCode r" id="cb824"><code class="sourceCode r"><a class="sourceLine" id="cb824-1" data-line-number="1">TP &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb824-2" data-line-number="2">IM &lt;-<span class="st"> </span><span class="fl">0.4</span></a></code></pre>
<p>And define the initial state of the CAM:</p>
<pre class="sourceCode r" id="cb825"><code class="sourceCode r"><a class="sourceLine" id="cb825-1" data-line-number="1">cases &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb825-2" data-line-number="2">cases[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb825-3" data-line-number="3">immune &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbinom</span>(<span class="dv">361</span>, <span class="dv">1</span>, IM), <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb825-4" data-line-number="4">immune[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb825-5" data-line-number="5">ti &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb825-6" data-line-number="6">ti[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb825-7" data-line-number="7">cam.state &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">grid =</span> cases, <span class="dt">immune =</span> immune, <span class="dt">ti =</span> ti)</a></code></pre>
<p>We can now run the simulation:</p>
<pre class="sourceCode r" id="cb826"><code class="sourceCode r"><a class="sourceLine" id="cb826-1" data-line-number="1"><span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">120</span>)</a></code></pre>
<p>Recording the time-step at which individual cells become infected allows us to plot an epidemic curve from the model:</p>
<pre class="sourceCode r" id="cb827"><code class="sourceCode r"><a class="sourceLine" id="cb827-1" data-line-number="1"><span class="kw">x11</span>()</a>
<a class="sourceLine" id="cb827-2" data-line-number="2"><span class="kw">hist</span>(cam.state<span class="op">$</span>ti)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-582-1.png" width="672" /></p>
<p>Remember, if you are using a Macintosh computer then you can use <code>quartz()</code> instead of <code>x11()</code>. This will give better results.</p>
<p>The <code>image()</code> function can provide an alternative view of the same data:</p>
<pre class="sourceCode r" id="cb828"><code class="sourceCode r"><a class="sourceLine" id="cb828-1" data-line-number="1"><span class="kw">image</span>(cam.state<span class="op">$</span>ti, <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a></code></pre>
<p><img src="prfe_files/figure-html/unnamed-chunk-583-1.png" width="672" /></p>
<p>The colour of each cell reflects the time-step of infection (i.e. the darker cells were infected before the lighter cells).</p>
<p>The CAM models that we have developed are general models of an infectious phenomenon. They could, for example, be models of the spread of an item of gossip, a forest fire, or an ink-spot. They are, however, poorly specified models for the epidemic spread of an infectious disease. In particular, they assume that a cell is infectious to other cells immediately after infection, that an infected cell never loses its ability to infect other cells, recovery never takes place, and immunity is never acquired. These deficits in the models may be addressed by appropriate modification of the CAM rule-set.</p>
<p>A simple and useful model of epidemic spread is the <em>SIR</em> model. The letters in <em>SIR</em> refer to the three states that influence epidemic spread that an individual can exist in. The three states are <strong>S</strong>usceptible, <strong>I</strong>nfectious, and <strong>R</strong>ecovered.</p>
<p>We will now modify our CAM model to follow the <em>SIR</em> model using the following parameters:</p>
<ul>
<li><p><strong>Susceptible</strong>: A cell may be immune or non-immune. A cell may be immune prior to the epidemic or
acquire immunity fourteen time-steps after infection. Once a cell is immune it remains immune.</p></li>
<li><p><strong>Infectious</strong>: An infected cell is infectious from eight to fourteen time-steps after being infected.</p></li>
<li><p><strong>Recovered</strong>: A cell is clinically sick from ten to twenty time-steps after being infected. If one time-step is taken to equal one day, these parameters provide a coarse simulation of the course of a measles infection.</p></li>
</ul>
<p>Use the <code>fix()</code> function to edit the <code>cam.rule()</code> function:</p>
<pre class="sourceCode r" id="cb829"><code class="sourceCode r"><a class="sourceLine" id="cb829-1" data-line-number="1"><span class="kw">fix</span>(cam.rule)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb830"><code class="sourceCode r"><a class="sourceLine" id="cb830-1" data-line-number="1"><span class="cf">function</span>(V, N, S, E, W, x, y, t) {</a>
<a class="sourceLine" id="cb830-2" data-line-number="2">  tsi &lt;-<span class="st"> </span>t <span class="op">-</span><span class="st"> </span>cam.state<span class="op">$</span>ti[x, y]</a>
<a class="sourceLine" id="cb830-3" data-line-number="3">  cam.state.new<span class="op">$</span>grid[x, y] &lt;&lt;-<span class="st"> </span><span class="kw">ifelse</span>(tsi <span class="op">%in%</span><span class="st"> </span>INFECTIOUS, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb830-4" data-line-number="4">  cam.state.new<span class="op">$</span>cf[x, y] &lt;&lt;-<span class="st"> </span><span class="kw">ifelse</span>(tsi <span class="op">%in%</span><span class="st"> </span>CLINICAL, <span class="dv">1</span>, <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb830-5" data-line-number="5">  cam.state.new<span class="op">$</span>immune[x, y] &lt;&lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="op">!</span><span class="kw">is.na</span>(tsi) <span class="op">&amp;</span><span class="st">  </span>tsi <span class="op">&gt;</span><span class="st"> </span>IMMUNITY, <span class="dv">1</span>, cam.state<span class="op">$</span>immune[x,y])</a>
<a class="sourceLine" id="cb830-6" data-line-number="6">     </a>
<a class="sourceLine" id="cb830-7" data-line-number="7">  <span class="cf">if</span>(cam.state<span class="op">$</span>infected[x, y] <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb830-8" data-line-number="8">    cam.state.new<span class="op">$</span>infected[x, y] &lt;&lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb830-9" data-line-number="9">    cam.state.new<span class="op">$</span>ti[x, y] &lt;&lt;-<span class="st"> </span>cam.state<span class="op">$</span>ti[x, y]</a>
<a class="sourceLine" id="cb830-10" data-line-number="10">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb830-11" data-line-number="11">    tp &lt;-<span class="st"> </span><span class="kw">c</span>(N, S, E, W) <span class="op">*</span><span class="st"> </span><span class="kw">rbinom</span>(<span class="dv">4</span>, <span class="dv">1</span>, TP)</a>
<a class="sourceLine" id="cb830-12" data-line-number="12">    </a>
<a class="sourceLine" id="cb830-13" data-line-number="13">    <span class="cf">if</span>(<span class="kw">sum</span>(tp) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span> <span class="op">&amp;</span><span class="st"> </span>cam.state<span class="op">$</span>immune[x, y] <span class="op">!=</span><span class="st"> </span><span class="dv">1</span>) {</a>
<a class="sourceLine" id="cb830-14" data-line-number="14">      cam.state.new<span class="op">$</span>infected[x, y] &lt;&lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb830-15" data-line-number="15">      cam.state.new<span class="op">$</span>ti[x, y] &lt;&lt;-<span class="st"> </span>t</a>
<a class="sourceLine" id="cb830-16" data-line-number="16">    }</a>
<a class="sourceLine" id="cb830-17" data-line-number="17">  } </a>
<a class="sourceLine" id="cb830-18" data-line-number="18">}</a></code></pre>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>It will also be useful to have a more detailed report of the state of the CAM at each time-step.</p>
<p>Use the <code>fix()</code> function to edit the <code>cam.state.display()</code> function:</p>
<pre class="sourceCode r" id="cb831"><code class="sourceCode r"><a class="sourceLine" id="cb831-1" data-line-number="1"><span class="kw">fix</span>(cam.state.display)</a></code></pre>
<p>Edit the function to read:</p>
<pre class="sourceCode r" id="cb832"><code class="sourceCode r"><a class="sourceLine" id="cb832-1" data-line-number="1"><span class="cf">function</span>(t) {</a>
<a class="sourceLine" id="cb832-2" data-line-number="2">  <span class="cf">if</span>(t <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb832-3" data-line-number="3">    <span class="kw">x11</span>(<span class="dt">width =</span> <span class="dv">9</span>, <span class="dt">height =</span> <span class="dv">9</span>)</a>
<a class="sourceLine" id="cb832-4" data-line-number="4">    <span class="kw">par</span>(<span class="dt">mfrow =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb832-5" data-line-number="5">    <span class="kw">par</span>(<span class="dt">pty =</span> <span class="st">&quot;s&quot;</span>)</a>
<a class="sourceLine" id="cb832-6" data-line-number="6">  }</a>
<a class="sourceLine" id="cb832-7" data-line-number="7">     </a>
<a class="sourceLine" id="cb832-8" data-line-number="8">  <span class="kw">image</span>(cam.state<span class="op">$</span>grid,</a>
<a class="sourceLine" id="cb832-9" data-line-number="9">        <span class="dt">main =</span> <span class="kw">paste</span>(<span class="st">&quot;Infectious at :&quot;</span>, t),</a>
<a class="sourceLine" id="cb832-10" data-line-number="10">        <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;wheat&quot;</span>, <span class="st">&quot;navy&quot;</span>), <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb832-11" data-line-number="11">     </a>
<a class="sourceLine" id="cb832-12" data-line-number="12">  <span class="kw">image</span>(cam.state<span class="op">$</span>cf,</a>
<a class="sourceLine" id="cb832-13" data-line-number="13">        <span class="dt">main =</span> <span class="kw">paste</span>(<span class="st">&quot;Clinical at :&quot;</span>, t),</a>
<a class="sourceLine" id="cb832-14" data-line-number="14">        <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;wheat&quot;</span>, <span class="st">&quot;navy&quot;</span>), <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb832-15" data-line-number="15">     </a>
<a class="sourceLine" id="cb832-16" data-line-number="16">  <span class="kw">image</span>(cam.state<span class="op">$</span>ti,</a>
<a class="sourceLine" id="cb832-17" data-line-number="17">        <span class="dt">main =</span> <span class="kw">paste</span>(<span class="st">&quot;Infected at :&quot;</span>, t), <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb832-18" data-line-number="18">     </a>
<a class="sourceLine" id="cb832-19" data-line-number="19">  <span class="kw">image</span>(cam.state<span class="op">$</span>immune,</a>
<a class="sourceLine" id="cb832-20" data-line-number="20">        <span class="dt">main =</span> <span class="kw">paste</span>(<span class="st">&quot;Immune at :&quot;</span>, t),</a>
<a class="sourceLine" id="cb832-21" data-line-number="21">        <span class="dt">col =</span> <span class="kw">c</span>(<span class="st">&quot;wheat&quot;</span>, <span class="st">&quot;navy&quot;</span>), <span class="dt">axes =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb832-22" data-line-number="22">}</a></code></pre>
<p>Remember, if you are using a Macintosh computer then you can use <code>quartz()</code> instead of <code>x11()</code>. This will give better results.</p>
<p>Once you have made the changes shown above, check your work, save the file, and quit the editor.</p>
<p>We need to specify values for the transmission pressure (<code>TP</code>) and the proportion of the population that is
immune (<code>IM</code>):</p>
<pre class="sourceCode r" id="cb833"><code class="sourceCode r"><a class="sourceLine" id="cb833-1" data-line-number="1">TP &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb833-2" data-line-number="2">IM &lt;-<span class="st"> </span><span class="fl">0.2</span></a></code></pre>
<p>And the <em>SIR</em> parameters:</p>
<pre class="sourceCode r" id="cb834"><code class="sourceCode r"><a class="sourceLine" id="cb834-1" data-line-number="1">CLINICAL &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">:</span><span class="dv">20</span></a>
<a class="sourceLine" id="cb834-2" data-line-number="2">INFECTIOUS &lt;-<span class="st"> </span><span class="dv">8</span><span class="op">:</span><span class="dv">14</span></a>
<a class="sourceLine" id="cb834-3" data-line-number="3">IMMUNITY &lt;-<span class="st"> </span><span class="dv">14</span></a></code></pre>
<p>And define the initial state of the CAM:</p>
<pre class="sourceCode r" id="cb835"><code class="sourceCode r"><a class="sourceLine" id="cb835-1" data-line-number="1">infected &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb835-2" data-line-number="2">infected[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb835-3" data-line-number="3">ti &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb835-4" data-line-number="4">ti[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb835-5" data-line-number="5">infectious &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb835-6" data-line-number="6">immune &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbinom</span>(<span class="dv">361</span>, <span class="dv">1</span>, IM), <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb835-7" data-line-number="7">immune[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb835-8" data-line-number="8">cf &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb835-9" data-line-number="9">cam.state &lt;-<span class="st">  </span><span class="kw">list</span>(<span class="dt">grid =</span> infectious, <span class="dt">infected =</span> infected, <span class="dt">ti =</span> ti,</a>
<a class="sourceLine" id="cb835-10" data-line-number="10">                   <span class="dt">immune =</span> immune, <span class="dt">cf =</span> cf)</a></code></pre>
<p>We should also record the number of susceptible cells for later use:</p>
<pre class="sourceCode r" id="cb836"><code class="sourceCode r"><a class="sourceLine" id="cb836-1" data-line-number="1">susceptibles &lt;-<span class="st"> </span><span class="dv">361</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(cam.state<span class="op">$</span>immune)</a></code></pre>
<p>We can now run the simulation:</p>
<pre class="sourceCode r" id="cb837"><code class="sourceCode r"><a class="sourceLine" id="cb837-1" data-line-number="1"><span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">200</span>)</a></code></pre>
<p>We can now calculate the proportion of susceptible (i.e. non-immune) cells that become infected:</p>
<pre class="sourceCode r" id="cb838"><code class="sourceCode r"><a class="sourceLine" id="cb838-1" data-line-number="1"><span class="kw">sum</span>(cam.state<span class="op">$</span>infected) <span class="op">/</span><span class="st"> </span>susceptibles</a></code></pre>
<pre><code>## [1] 0.003322259</code></pre>
<p>We can use this model to test the effect of an intervention such as isolating an infected cell for a short period after clinical features first appear. We can do this, imperfectly because it does not allow us to specify compliance, by shortening the infectious period to include only the non-symptomatic time-steps and one time- step after clinical features have appeared:</p>
<pre class="sourceCode r" id="cb840"><code class="sourceCode r"><a class="sourceLine" id="cb840-1" data-line-number="1">INFECTIOUS &lt;-<span class="st"> </span><span class="dv">8</span><span class="op">:</span><span class="dv">11</span></a></code></pre>
<p>resetting the initial state of the CAM:</p>
<pre class="sourceCode r" id="cb841"><code class="sourceCode r"><a class="sourceLine" id="cb841-1" data-line-number="1">infected &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb841-2" data-line-number="2">infected[<span class="dv">10</span>, <span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb841-3" data-line-number="3">ti &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb841-4" data-line-number="4">ti[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb841-5" data-line-number="5">infectious &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb841-6" data-line-number="6">immune &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rbinom</span>(<span class="dv">361</span>, <span class="dv">1</span>, IM), <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb841-7" data-line-number="7">immune[<span class="dv">10</span>,<span class="dv">10</span>] &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb841-8" data-line-number="8">cf &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, <span class="dt">nrow =</span> <span class="dv">19</span>, <span class="dt">ncol =</span> <span class="dv">19</span>)</a>
<a class="sourceLine" id="cb841-9" data-line-number="9">cam.state &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">grid =</span> infectious, <span class="dt">infected =</span> infected, <span class="dt">ti =</span> ti,</a>
<a class="sourceLine" id="cb841-10" data-line-number="10">                  <span class="dt">immune =</span> immune, <span class="dt">cf =</span> cf)</a></code></pre>
<p>Recording the number of susceptible cells:</p>
<pre class="sourceCode r" id="cb842"><code class="sourceCode r"><a class="sourceLine" id="cb842-1" data-line-number="1">susceptibles &lt;-<span class="st"> </span><span class="dv">361</span> <span class="op">-</span><span class="st"> </span><span class="kw">sum</span>(cam.state<span class="op">$</span>immune)</a></code></pre>
<p>Running the simulation:</p>
<pre class="sourceCode r" id="cb843"><code class="sourceCode r"><a class="sourceLine" id="cb843-1" data-line-number="1"><span class="kw">cam.run</span>(<span class="dt">steps =</span> <span class="dv">200</span>)</a></code></pre>
<p>And recalculating the proportion of susceptible (i.e. non-immune) cells that become infected:</p>
<pre class="sourceCode r" id="cb844"><code class="sourceCode r"><a class="sourceLine" id="cb844-1" data-line-number="1"><span class="kw">sum</span>(cam.state<span class="op">$</span>infected) <span class="op">/</span><span class="st"> </span>susceptibles</a></code></pre>
<pre><code>## [1] 0.003448276</code></pre>
<p>We have developed a simple but realistic model of epidemic spread using a cellular automata machine. Such a model could be used to investigate the relative effect of model parameters (e.g. initial proportion immune, initial number of infective cells, transmission pressure, etc.) on epidemic spread by changing a single parameter at a time and running the simulation. Since the model is <em>stochastic</em>, the effect of each parameter change would be simulated many times and suitable summaries calculated.</p>
<p>The model could be improved by, for example:</p>
<ul>
<li><p>Allowing for an <em>open population</em> with births (or immigration) and deaths (or emigration). This could be implemented by allowing immune cells to become susceptible after a specified number of time-steps. The ratio of births to deaths could then be modelled as the ratio of the length of the infectious period to the length of the immune period.</p></li>
<li><p>Specifying a non-uniform distribution of transmission pressure during the infectious period.</p></li>
<li><p>Allowing for individual variation in susceptibility.</p></li>
<li><p>Allowing for individual variation in the duration of the infectious period.</p></li>
<li><p>Simulating a non-uniform population density by allowing cells to be empty. Note that an immune cell is the same as an empty cell in the current model.</p></li>
<li><p>Simulating a clustered distribution of immunity in the initial state of the CAM.</p></li>
<li><p>Allowing a small proportion of infections to be infectious without exhibiting clinical features.</p></li>
<li><p>Specifying rules that are applied at different time-points such as introducing isolation only after a certain number of clinical cases have appeared (i.e. after an epidemic has been detected).</p></li>
<li><p>Allowing the coverage of interventions (e.g. the coverage of a vaccination campaign or compliance with isolation instructions) that are introduced after an epidemic has been detected to be specified.</p></li>
<li><p>Simulating a more complex social structure. This could be implemented by allowing cells to belong to one of a finite set of castes with different initial conditions (e.g. immunity) and having rules that specify the level of interaction (i.e. the transmission pressure) between members of separate castes and the levels of intervention coverage achievable in the separate castes.</p></li>
<li><p>Extending the neighbourhood definition by using the corner (i.e. north-east, south-east, south-west, and north-west) cells as neighbours for consideration in the CAM rule-set.</p></li>
</ul>
<p>We can now quit <code>R</code>:</p>
<pre class="sourceCode r" id="cb846"><code class="sourceCode r"><a class="sourceLine" id="cb846-1" data-line-number="1"><span class="kw">q</span>()</a></code></pre>
<p>For this exercise there is no need to save the workspace image so click the <strong>No</strong> button (GUI) or enter <code>n</code> when prompted to save the workspace image (terminal).</p>
</div>
<div id="summary-8" class="section level2">
<h2><span class="header-section-number">9.5</span> Summary</h2>
<ul>
<li><p>Computer intensive methods provide an alternative to classical statistical techniques for both estimation and statistical hypothesis testing. They have the advantage of being simple to implement and they remain simple even with complex estimators.</p></li>
<li><p>Computer based simulation can simulate both data and processes. Process simulations maybe arbitrarily complex. Process simulation is a useful development tool that can save considerable time and expense when developing systems and methods.</p></li>
<li><p>Process simulation can also be used to model complex social phenomena such as epidemic spread. Such simulations allow (e.g.) the the relative efficacy of interventions to be evaluated.</p></li>
<li><p><code>R</code> provides functions that allow you to implement computer intensive methods such as the bootstrap and computer based simulation.</p></li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exercise8.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="what-now.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["prfe.pdf", "prfe.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
